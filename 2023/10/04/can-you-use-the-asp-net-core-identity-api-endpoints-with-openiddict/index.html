<!DOCTYPE html><html><head><meta charset="utf-8"><title>Can you use the ASP.NET Core Identity API endpoints with OpenIddict? | K√©vin Chalet&#39;s blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="TL;DR: yes, but please, don&#39;t do it! ü§£ If you&#39;re an avid reader of Andrew Lock&#39;s blog (certainly one of the best .NET blogs out there!), you probably figured out that the title of this blog post is v"><meta property="og:type" content="article"><meta property="og:title" content="Can you use the ASP.NET Core Identity API endpoints with OpenIddict?"><meta property="og:url" content="https://kevinchalet.com/2023/10/04/can-you-use-the-asp-net-core-identity-api-endpoints-with-openiddict/index.html"><meta property="og:site_name" content="K√©vin Chalet&#39;s blog"><meta property="og:description" content="TL;DR: yes, but please, don&#39;t do it! ü§£ If you&#39;re an avid reader of Andrew Lock&#39;s blog (certainly one of the best .NET blogs out there!), you probably figured out that the title of this blog post is v"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://kevinchalet.com/2023/10/04/can-you-use-the-asp-net-core-identity-api-endpoints-with-openiddict/github-message.png"><meta property="article:published_time" content="2023-10-04T11:00:00.000Z"><meta property="article:modified_time" content="2023-10-04T10:56:21.710Z"><meta property="article:author" content="K√©vin Chalet"><meta property="article:tag" content="asp.net core"><meta property="article:tag" content="authentication"><meta property="article:tag" content="oauth"><meta property="article:tag" content="openid connect"><meta property="article:tag" content="openiddict"><meta property="article:tag" content="identity"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://kevinchalet.com/2023/10/04/can-you-use-the-asp-net-core-identity-api-endpoints-with-openiddict/github-message.png"><meta name="twitter:creator" content="@kevin_chalet"><link rel="icon" href="https://kevinchalet.com/assets/photo.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css"><script type="text/javascript">!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-79360312-1","auto"),ga("send","pageview")</script><meta name="generator" content="Hexo 6.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><span class="site-title">K√©vin Chalet&#39;s blog</span></a><nav id="main-nav"><a class="main-nav-link" href="/.">Home</a> <a class="main-nav-link" href="/archives/">Archives</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"><a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://kevinchalet.com/assets/photo.png"><i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"></button><input type="hidden" name="sitesearch" value="https://kevinchalet.com"></form></div></div></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"><img id="avatar" src="https://kevinchalet.com/assets/photo.png"><h2 id="name">K√©vin Chalet</h2><h3 id="title">.NET-holic and OpenID-addict MVP in the wild.</h3><span id="location"><i class="fa fa-map-marker"></i>France</span> <a id="follow" target="_blank" rel="noopener" href="https://twitter.com/intent/user?screen_name=kevin_chalet"><i class="fa fa-twitter fa-lg"></i> Follow me on Twitter</a></div><div class="article-info profile-block"><div class="article-info-block">44 <span>posts</span></div><div class="article-info-block">37 <span>tags</span></div></div><div class="contact-info profile-block"><table class="contact-list"><tr><td><a href="mailto:contact@kevinchalet.com" title="Email"><i class="fa fa-envelope"></i></a></td><td><a target="_blank" rel="noopener" href="https://www.linkedin.com/in/kevinchalet/" title="LinkedIn"><i class="fa fa-linkedin"></i></a></td><td><a target="_blank" rel="noopener" href="https://github.com/kevinchalet" title="GitHub"><i class="fa fa-github"></i></a></td><td><a target="_blank" rel="noopener" href="https://twitter.com/kevin_chalet" title="Twitter"><i class="fa fa-twitter"></i></a></td><td><a target="_blank" rel="noopener" href="https://stackoverflow.com/users/542757/k%c3%a9vin-chalet" title="StackOverflow"><i class="fa fa-stack-overflow"></i></a></td><td><a target="_blank" rel="noopener" href="https://mvp.microsoft.com/fr-fr/PublicProfile/5001682" title="Microsoft MVP"><i class="fa fa-windows"></i></a></td><td><a href="/atom.xml" title="RSS"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-can-you-use-the-asp-net-core-identity-api-endpoints-with-openiddict" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">Can you use the ASP.NET Core Identity API endpoints with OpenIddict?</h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2023/10/04/can-you-use-the-asp-net-core-identity-api-endpoints-with-openiddict/"><time datetime="2023-10-04T11:00:00.000Z" itemprop="datePublished">2023-10-04</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/development/">Development</a></div></div></header><div class="article-entry" itemprop="articleBody"><p><strong>TL;DR: yes, but please, don't do it! ü§£</strong></p><p>If you're an avid reader of <a target="_blank" rel="noopener" href="https://andrewlock.net/">Andrew Lock's blog</a> (certainly one of the best .NET blogs out there!), you probably figured out that the title of this blog post is very similar to his latest post, <a target="_blank" rel="noopener" href="https://andrewlock.net/can-you-use-the-dotnet-8-identity-api-endpoints-with-identityserver/">Can you use the .NET 8 Identity API endpoints with IdentityServer?</a>, in which he describes how you could (but really shouldn't üòÇ) use ASP.NET Core 8's Identity API endpoints with an OAuth 2.0/OpenID Connect server stack like IdentityServer or OpenIddict.</p><p>The similarity is of course completely deliberate, as his post motivated me to write this one.</p><p>The approach described in Andrew's post ‚Äì that mainly consists in using the Identity API endpoints introduced by .NET 8 to handle the user authentication part ‚Äì also works with OpenIddict, so there's no point covering the same aspects twice: if you haven't read it, please read Andrew's post before reading mine.</p><p><strong>Instead, we're going to do something even crazier ('cause why not? üòé): using OpenIddict to process token requests handled by the Identity API login endpoint... and generate token responses containing either JWT or ASP.NET Core Data Protection access tokens!</strong></p><h2 id="ASP-NET-Core-Identity-39-s-API-endpoints-are-faux-OAuth-2-0-endpoints"><a href="#ASP-NET-Core-Identity-39-s-API-endpoints-are-faux-OAuth-2-0-endpoints" class="headerlink" title="ASP.NET Core Identity's API endpoints are faux-OAuth 2.0 endpoints..."></a>ASP.NET Core Identity's API endpoints are faux-OAuth 2.0 endpoints...</h2><p>As a preamble, it's important to note that while the ASP.NET team mentioned multiple times that the Identity API endpoints are not an OAuth 2.0 implementation, it's actually a non-standard equivalent of the OAuth 2.0 resource owner password credentials grant, as <a target="_blank" rel="noopener" href="https://github.com/dotnet/aspnetcore/issues/42158#issuecomment-1490021488">I demonstrated here</a>.</p><p>(if you're not convinced yet these endpoints are "heavily inspired" by OAuth 2.0, this message posted by Stephen Halter ‚Äì who wrote the ASP.NET Core Identity API endpoints feature ‚Äì should speak for itself üòÅ)</p><img src="/2023/10/04/can-you-use-the-asp-net-core-identity-api-endpoints-with-openiddict/github-message.png"><h2 id="that-can-be-used-with-OpenIddict-nevertheless"><a href="#that-can-be-used-with-OpenIddict-nevertheless" class="headerlink" title="... that can be used with OpenIddict nevertheless"></a>... that can be used with OpenIddict nevertheless</h2><p>Why is this "OAuth 2.0/not OAuth 2.0" distinction important you may ask? Well, since the ASP.NET Core Identity API endpoints implement a clone of the OAuth 2.0 resource owner password credentials grant with only a few differences, it's going to be very easy to use OpenIddict's advanced events model to make it compatible with the non-standard protocol created by the ASP.NET team.</p><h3 id="Create-a-minimal-ASP-NET-Core-API-and-enable-the-ASP-NET-Core-Identity-API-endpoints"><a href="#Create-a-minimal-ASP-NET-Core-API-and-enable-the-ASP-NET-Core-Identity-API-endpoints" class="headerlink" title="Create a minimal ASP.NET Core API and enable the ASP.NET Core Identity API endpoints"></a>Create a minimal ASP.NET Core API and enable the ASP.NET Core Identity API endpoints</h3><p>For that, create a new <code>.csproj</code> referencing the ASP.NET Core Identity UI, the OpenIddict ASP.NET Core metapackage and the EF Core packages:</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">"Microsoft.NET.Sdk.Web"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>net8.0<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Nullable</span>&gt;</span>enable<span class="tag">&lt;/<span class="name">Nullable</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImplicitUsings</span>&gt;</span>enable<span class="tag">&lt;/<span class="name">ImplicitUsings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore"</span> <span class="attr">Version</span>=<span class="string">"8.0.0-rc.1.23421.29"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.AspNetCore.Identity.EntityFrameworkCore"</span> <span class="attr">Version</span>=<span class="string">"8.0.0-rc.1.23421.29"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.AspNetCore.Identity.UI"</span> <span class="attr">Version</span>=<span class="string">"8.0.0-rc.1.23421.29"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.EntityFrameworkCore.SqlServer"</span> <span class="attr">Version</span>=<span class="string">"8.0.0-rc.1.23419.6"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.EntityFrameworkCore.Tools"</span> <span class="attr">Version</span>=<span class="string">"8.0.0-rc.1.23419.6"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"OpenIddict.AspNetCore"</span> <span class="attr">Version</span>=<span class="string">"4.8.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"OpenIddict.EntityFrameworkCore"</span> <span class="attr">Version</span>=<span class="string">"4.8.0"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><span id="more"></span><p>We'll also need a custom <code>DbContext</code> derived from <code>IdentityDbContext</code>:</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Identity.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">OpenIddictIdentityEndpoints.Data</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ApplicationDbContext</span>(<span class="params">DbContextOptions&lt;ApplicationDbContext&gt; options</span>)</span></span><br><span class="line"><span class="function">    : <span class="title">IdentityDbContext</span>(<span class="params">options</span>)</span></span><br><span class="line">{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Last but not least, we'll also need an entry point registering the DI services and the middleware we'll need:</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authentication.BearerToken;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Identity;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> OpenIddict.Server.AspNetCore;</span><br><span class="line"><span class="keyword">using</span> OpenIddict.Validation.AspNetCore;</span><br><span class="line"><span class="keyword">using</span> OpenIddictIdentityEndpoints;</span><br><span class="line"><span class="keyword">using</span> OpenIddictIdentityEndpoints.Data;</span><br><span class="line"><span class="keyword">using</span> System.Security.Claims;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line"></span><br><span class="line">builder.Services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;</span><br><span class="line">{</span><br><span class="line">    options.UseOpenIddict();</span><br><span class="line">    options.UseSqlServer(<span class="string">"Server=(localdb)\\mssqllocaldb;Database=openiddict-identity-endpoints-sample;Trusted_Connection=True;MultipleActiveResultSets=true"</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">builder.Services.AddDatabaseDeveloperPageExceptionFilter();</span><br><span class="line">builder.Services.AddAuthorization();</span><br><span class="line"></span><br><span class="line">builder.Services.AddIdentityApiEndpoints&lt;IdentityUser&gt;()</span><br><span class="line">    .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();</span><br><span class="line"></span><br><span class="line">builder.Services.AddOpenIddict()</span><br><span class="line">    .AddCore(options =&gt;</span><br><span class="line">    {</span><br><span class="line">        options.UseEntityFrameworkCore().UseDbContext&lt;ApplicationDbContext&gt;();</span><br><span class="line">    })</span><br><span class="line">    .AddServer(options =&gt;</span><br><span class="line">    {</span><br><span class="line">        options.AllowPasswordFlow();</span><br><span class="line">        options.SetTokenEndpointUris(<span class="string">"login"</span>);</span><br><span class="line"></span><br><span class="line">        options.AcceptAnonymousClients();</span><br><span class="line"></span><br><span class="line">        options.AddDevelopmentEncryptionCertificate();</span><br><span class="line">        options.AddDevelopmentSigningCertificate();</span><br><span class="line"></span><br><span class="line">        options.UseAspNetCore().EnableTokenEndpointPassthrough();</span><br><span class="line">    })</span><br><span class="line">    .AddValidation(options =&gt;</span><br><span class="line">    {</span><br><span class="line">        options.UseLocalServer();</span><br><span class="line"></span><br><span class="line">        options.UseAspNetCore();</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (app.Environment.IsDevelopment())</span><br><span class="line">{</span><br><span class="line">    app.UseMigrationsEndPoint();</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">    app.UseExceptionHandler(<span class="string">"/Error"</span>);</span><br><span class="line">    app.UseHsts();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">app.UseHttpsRedirection();</span><br><span class="line">app.UseStaticFiles();</span><br><span class="line"></span><br><span class="line">app.UseRouting();</span><br><span class="line"></span><br><span class="line">app.UseAuthentication();</span><br><span class="line">app.UseAuthorization();</span><br><span class="line"></span><br><span class="line">app.MapGet(<span class="string">"/"</span>, () =&gt; <span class="string">"Hello, World!"</span>);</span><br><span class="line">app.MapGet(<span class="string">"/requires-auth"</span>, (ClaimsPrincipal user) =&gt; <span class="string">$"Hello, <span class="subst">{user.Identity?.Name}</span>!"</span>).RequireAuthorization();</span><br><span class="line"></span><br><span class="line">app.MapIdentityApi&lt;IdentityUser&gt;();</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></tbody></table></figure><p>To initialize the database with the Identity and OpenIddict tables, run <code>dotnet ef migrations add CreateOpenIddictSchema</code> and <code>dotnet ef database update</code>. Once it's initialized, you can create a new account by sending a JSON payload to <code>/register</code> containing the email address and the password:</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"email"</span><span class="punctuation">:</span> <span class="string">"alice@wonderland.com"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"password"</span><span class="punctuation">:</span> <span class="string">"11uP$4#^==@/"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p>So far, nothing fancy: EF Core, ASP.NET Core Identity and OpenIddict are configured like in any other app. The only interesting part is that OpenIddict is set up to allow the password flow and <strong>use the same <code>/login</code> address for its token endpoint as the login endpoint used by Identity (added for you when calling <code>app.MapIdentityApi&lt;IdentityUser&gt;()</code>)</strong>.</p><h3 id="Add-custom-event-handlers-to-tweak-the-token-endpoint-processing-logic"><a href="#Add-custom-event-handlers-to-tweak-the-token-endpoint-processing-logic" class="headerlink" title="Add custom event handlers to tweak the token endpoint processing logic"></a>Add custom event handlers to tweak the token endpoint processing logic</h3><p>If you try to send a request to Identity's login endpoint, all you'll get is an OAuth 2.0 error returned by OpenIddict telling you that that the specified <code>Content-Type</code> HTTP header is not valid:</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"error"</span><span class="punctuation">:</span> <span class="string">"invalid_request"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"error_description"</span><span class="punctuation">:</span> <span class="string">"The specified 'Content-Type' header is invalid."</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"error_uri"</span><span class="punctuation">:</span> <span class="string">"https://documentation.openiddict.com/errors/ID2082"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p>It's expected: <strong>while the custom protocol derived by the ASP.NET team uses JSON as input, the standard OAuth 2.0 protocol uses formURL-encoded requests</strong>.</p><p>To accomodate that, we'll need to use OpenIddict's events model to extract OAuth 2.0 token requests from JSON payloads instead of formURL-encoded requests. We'll also need to map non-standard parameters and claims to their standard equivalent.</p><p>For that, we'll create an extensions class that will centralize our custom event handlers:</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore;</span><br><span class="line"><span class="keyword">using</span> OpenIddict.Abstractions;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.Security.Claims;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">static</span> OpenIddict.Abstractions.OpenIddictConstants;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">static</span> OpenIddict.Server.AspNetCore.OpenIddictServerAspNetCoreHandlerFilters;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">static</span> OpenIddict.Server.AspNetCore.OpenIddictServerAspNetCoreHandlers;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">static</span> OpenIddict.Server.OpenIddictServerEvents;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">OpenIddictIdentityEndpoints</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">OpenIddictServerExtensions</span></span><br><span class="line">{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OpenIddictServerBuilder <span class="title">AddCustomHandlers</span>(<span class="params"><span class="keyword">this</span> OpenIddictServerBuilder builder</span>)</span></span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// Remove the built-in event handler responsible for extracting standard OAuth 2.0 token requests</span></span><br><span class="line">        <span class="comment">// (that always use form-URL encoding) and replace it by an equivalent supporting JSON payloads.</span></span><br><span class="line">        builder.RemoveEventHandler(ExtractPostRequest&lt;ExtractTokenRequestContext&gt;.Descriptor);</span><br><span class="line">        builder.AddEventHandler&lt;ExtractTokenRequestContext&gt;(builder =&gt;</span><br><span class="line">        {</span><br><span class="line">            builder.UseInlineHandler(<span class="keyword">async</span> context =&gt;</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">var</span> request = context.Transaction.GetHttpRequest() ?? <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!HttpMethods.IsPost(request.Method) || <span class="built_in">string</span>.IsNullOrEmpty(request.ContentType) ||</span><br><span class="line">                    !request.ContentType.StartsWith(<span class="string">"application/json"</span>, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">                {</span><br><span class="line">                    context.Reject(Errors.InvalidRequest);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Enable buffering and rewind the request body after extracting the JSON payload to ensure</span></span><br><span class="line">                <span class="comment">// the ASP.NET Core Identity API endpoint can also resolve the request parameters.</span></span><br><span class="line"></span><br><span class="line">                request.EnableBuffering();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                {</span><br><span class="line">                    context.Request = <span class="keyword">await</span> request.ReadFromJsonAsync&lt;OpenIddictRequest&gt;() ?? <span class="keyword">new</span>();</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">finally</span></span><br><span class="line">                {</span><br><span class="line">                    request.Body.Position = <span class="number">0L</span>;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Unlike a standard OAuth 2.0 implementation, ASP.NET Core Identity's login endpoint doesn't</span></span><br><span class="line">                <span class="comment">// specify the grant_type parameter. Since it's the only authentication method supported anyway,</span></span><br><span class="line">                <span class="comment">// assume all token requests are resource owner password credentials (ROPC) requests.</span></span><br><span class="line">                context.Request.GrantType = GrantTypes.Password;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// The latest version of the ASP.NET Core Identity API package uses "email" instead of the</span></span><br><span class="line">                <span class="comment">// standard OAuth 2.0 username parameter. To work around that, the email parameter is manually</span></span><br><span class="line">                <span class="comment">// mapped to the standard OAuth 2.0 username parameter.</span></span><br><span class="line">                context.Request.Username = (<span class="built_in">string</span>?) context.Request[<span class="string">"email"</span>];</span><br><span class="line">            });</span><br><span class="line"></span><br><span class="line">            builder.AddFilter&lt;RequireHttpRequest&gt;();</span><br><span class="line">            builder.SetOrder(ExtractPostRequest&lt;ExtractTokenRequestContext&gt;.Descriptor.Order);</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        builder.AddEventHandler&lt;ProcessSignInContext&gt;(builder =&gt;</span><br><span class="line">        {</span><br><span class="line">            builder.UseInlineHandler(context =&gt;</span><br><span class="line">            {</span><br><span class="line">                Debug.Assert(context.Principal <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// OpenIddict requires specifying the standard OpenID Connect "sub" claim that identifies</span></span><br><span class="line">                <span class="comment">// the user. Since it's not specified by ASP.NET Core Identity's login endpoint, it is</span></span><br><span class="line">                <span class="comment">// manually mapped from the ClaimTypes.NameIdentifier claim that is added by Identity.</span></span><br><span class="line">                context.Principal.SetClaim(Claims.Subject, context.Principal.FindFirst(ClaimTypes.NameIdentifier)?.Value);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Allow OpenIddict to store all the claims generated by ASP.NET Core Identity in the access tokens.</span></span><br><span class="line">                context.Principal.SetDestinations(<span class="keyword">static</span> claim =&gt; [Destinations.AccessToken]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">default</span>;</span><br><span class="line">            });</span><br><span class="line"></span><br><span class="line">            builder.SetOrder(<span class="built_in">int</span>.MinValue);</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>You can now easily register your custom event handlers by calling the <code>options.AddCustomHandlers()</code> extension we just added:</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddOpenIddict()</span><br><span class="line">    .AddServer(options =&gt;</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        options.AddCustomHandlers();</span><br><span class="line">    });</span><br></pre></td></tr></tbody></table></figure><h3 id="Amend-the-BearerTokenOptions-to-forward-the-authentication-operations-to-OpenIddict"><a href="#Amend-the-BearerTokenOptions-to-forward-the-authentication-operations-to-OpenIddict" class="headerlink" title="Amend the BearerTokenOptions to forward the authentication operations to OpenIddict"></a>Amend the <code>BearerTokenOptions</code> to forward the authentication operations to OpenIddict</h3><p><strong>At this point, if you run the application as-is, you'll see that the <code>/login</code> responses are still generated by the ASP.NET Core Identity API stack and not by OpenIddict</strong>. The explanation is actually quite simple: we're still missing the secret sauce that is needed to let OpenIddict generate token responses for the requests handled by the <code>/login</code> API endpoint.</p><p>For that, we'll need to tweak the <code>BearerTokenOptions</code> to forward the sign-in operations to the OpenIddict server stack. It's also the right place to redirect token validation to the OpenIddict validation stack:</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.Configure&lt;BearerTokenOptions&gt;(IdentityConstants.BearerScheme, options =&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="comment">// Forward the sign-in responses returned by ASP.NET Core Identity's</span></span><br><span class="line">    <span class="comment">// login API endpoint to the OpenIddict server stack so that OpenIddict</span></span><br><span class="line">    <span class="comment">// can generate a token response based on the principal prepared by Identity.</span></span><br><span class="line">    options.ForwardSignIn = OpenIddictServerAspNetCoreDefaults.AuthenticationScheme;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Forward the token authentication operations to the OpenIddict validation stack.</span></span><br><span class="line">    options.ForwardAuthenticate = OpenIddictValidationAspNetCoreDefaults.AuthenticationScheme;</span><br><span class="line">    options.ForwardChallenge = OpenIddictValidationAspNetCoreDefaults.AuthenticationScheme;</span><br><span class="line">    options.ForwardForbid = OpenIddictValidationAspNetCoreDefaults.AuthenticationScheme;</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p>With that in place, if you send a <code>/login</code> request with valid user credentials, you'll see that a standard OAuth 2.0 response is returned by OpenIddict and contains an encrypted JWT token:</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"email"</span><span class="punctuation">:</span> <span class="string">"alice@wonderland.com"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"password"</span><span class="punctuation">:</span> <span class="string">"11uP$4#^==@/"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"access_token"</span><span class="punctuation">:</span> <span class="string">"eyJhbGciOiJSU0EtT0FFUCIsImVuYyI6IkEyNTZDQkMtSFM1MTIiLCJraWQiOiI2MDFFQ0YzOTE5Nzk0QjFEMDJGQzQ3NzM3QjdGQjVGMzAwN0NDQjgzIiwidHlwIjoiYXQrand0IiwiY3R5IjoiSldUIn0.Wex4QAYwlj-8LIp2IGOv5wgObeYzjQU_SqH50sIpfsyAq4OfY6D_xb1Zr1hedPd9WtpKR9xsVtVA6c0aMwMwTQBXCp4jb3p8i5pRk_B0_456SxtiWhzriYiEiQdJHn4trbGQJewYPlE8aoycqKj1vjpOFZVlV3Hl5b45ScBghozrnLXY-JTPl7RKmYGkVybQ5RuqBqUDOyQ6I8I8X53teZ2NlBYH3z52vpeiZ-pNxkjw4qf56Td5hqT0v0o3FFYXbrnP4g_ICC6AC91cRMeaOZioqA5EsQefvGDGIvCmVo0Ji4X0FPr5qZX8sMaBGllQ6IaQV69r8ROBW-0VdVTQjw.k36euUymXI0SUp74X8vN7A.w8tCJYZrsjlG1WZb4hJbWdBEMXFxkP_0R5mgJBNXCjTV2Y5FLq3kCcW3eRwc8qWKNlDBZZoOnCUjBxrtExk6mbZRyTCPni50G3iDYbXTHqtnYz7gor5AcAXM7_DobSgKetdQE4cV2jUNQEO4jbGj-CC7X3tPe_WOgXGY2rpjNVfanBUKtwsbruSDvqOTxYNTBJGdW7mPlbriWiUgoEso2Hhpas_IINJO-H3gic0FfhJfU9u02ObXs19Z1ZmfmfuZ4-_C6jdYPOaVA8cKjUOJPF8aodBZksStLYwcGLwf02x264o5uuM4meMRzQUN7OiWh4jOblhCSQXPXCSO5jBzUZNvg8h5GyxbtqOgir5UF99_bEdAw2PJMJIU8zVSE4iZLW3vvdKaZg9m9c46SXks9P3X_IiqPsQdSWzNRqHqOzn3nguub_ufw_2RfwYYCSgSfFqKrozMXSQxKR2iTrcqiJrpQjdut6ny9DxwcRjZxcXA4gcw_2CaBVsHaI16bFrSs17YkEycRRQRhGJYd8e50y5VmAwx8XJHn_ahoQEvMKgXexuKx1Vsk178fZRdW-QHA0a9qf0LrPUToVOSyhZrM2neSNSuXoa6VyJjQ0MzFEi829brhPnHqmn3qxs1HKT5olr5iGc_WZDcDGOFVdLstLVN2dixG8phgP6krYUXsy-O6u0Q5tpoLZLf_EQMSu_jExl-pm5F_5wDT0NrUC8frZqnHSQii_SLWRsUSu3ORMMwv_pHKVjCOeI19MUx_h6Djv2LzKujXNCcafj0rwRUKzIQG3CNQffNPASrznxT629k3nnEELP1R5i-AOIYF2msJdy0tiJ491zN3J0w9GyduTcxHwkxgACqeYCIOG3Td0pPdHDIsO-UKbUiNnZbRUjEYLMu2Rne6MJYG8ogJfXaWOszIyZxKolkcSKxguIyHacGpuxhnhsbwzHtvn_-wNnNOlD31TuO0M3I_Z_FquWvBllxqSMaYtAiVCM1jpXnRaRODY_u44iUuJ8fk9R3Bj0MaXfghtuRSiZsz5Hf6qTLV5xCbreB11YZFrVhKGsI58lSQoy02jNEZCHn3Ta-af3ygE2RzsqlGNF7v9UkgZpdRpXlYnbAIaHavy8F3ItTcmChTQHFFxf5ACEntZ-KnV3hXW1x3KrjyselrRdxQhNssAT5zpQVB6MGbLeK4brhU-SMQctZww6-lfN7Qw4fTfTXZVywmkf8KRLwNICDKihLHK8sQzuuttj6BYHJDmJrKh0p3haLovehKK6xanjxaffliKzkR6YM7S5l8MjiM79Vrw1YAqaXKfr-OaC5WYV1Mtlx4rUE9pgk9yMEsUOrcJqy4qMxgv1ER-4Q0_JxOCUAiHceDNtSDPAN4wELPsCmlp8YQJnofHtU5Umua33JyY9Wou6tLFFfLLY4kH1pFeDUOQt2KkDcHTSXqGw_xm1I8V_FeBMAhQ7_EaeTvaUnrSUqeB4-5XH3cbSD42wrEIwDKyvOjcg6wcZIF39JknOlfzY6dc-OVCWX2PGC3fj1Y7-XTIhg1MjByw4KdIVo9nyPBOUfV_Zaq371116ZoviafH-85ZbNap9VVAd9RZr_X2VmUa_w2MbVQY-dLsqB-Kjcn3JOZMMlcjM77BYp8gjGAvNPswxXwCZsto3wiv79ZYBnLcknBOKlxjQFwE0q8OR0YsNx_dkgyTd3IoJIz8Vi6Yg.bvOOUI76EBbQ2WhOXreO-w_0RXJf730vM5VTgRwVSwY"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"token_type"</span><span class="punctuation">:</span> <span class="string">"Bearer"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"expires_in"</span><span class="punctuation">:</span> <span class="number">3600</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="What-if-I-prefer-ASP-NET-Core-Data-Protection-for-my-tokens"><a href="#What-if-I-prefer-ASP-NET-Core-Data-Protection-for-my-tokens" class="headerlink" title="What if I prefer ASP.NET Core Data Protection for my tokens?"></a>What if I prefer ASP.NET Core Data Protection for my tokens?</h2><p>Just like the ASP.NET Core Identity API endpoints, OpenIddict can use ASP.NET Core Data Protection as the token format. For that, just call <code>options.UseDataProtection()</code> from both <code>.AddServer(...)</code> and <code>.AddValidation(...)</code> and you'll get opaque tokens:</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddOpenIddict()</span><br><span class="line">    .AddServer(options =&gt;</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        options.UseDataProtection();</span><br><span class="line">    })</span><br><span class="line">    .AddValidation(options =&gt;</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        options.UseDataProtection();</span><br><span class="line">    });</span><br></pre></td></tr></tbody></table></figure><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"access_token"</span><span class="punctuation">:</span> <span class="string">"CfDJ8MjLq6GgozVHmdX5Xs26TkbrOWF10aeBeP4fUyy-Vyu1D7PqJyDxV_NAW0AnCB1OaJzpyQ9CP8HIRQI9mSOzLSpdO9OBlFc9NG5tJ9D6tHDeiuKvOZb3eIngnsgs0NDq_zf8zionU2qi4kerpP-sgOvo8Fk5uqi66AHmXTLyJFLyDCOPBnBQmrT3RLBrhMFkfkDajHaqhWRG29sqK_YHeiIWzUK4JLkHpyYdypcpmHCyBknkt8NFXXDtBEdbIkrVy4-LHPuLGGArzbP9R7RX_vIKxdwNZ-nEa_kHiw9sPHgJhqIH574kDetczGxnJHLLDpZ1cVAqfr8OUTSo4yq75OtPh9D4pbv7YhpZ2mfAiNFBNJno5X6cwzbG1SeopLfnXL2KBF0bcsmQqRx7bEzgzLZejMLpJs5Slfwf88wgOepBzGmcfmU3fakTW9n8S9aBFDFmeysbmzFjR4rbp-5e1qZRcsO0fzmQE17oejCFN7LvFTkZikF6yce_maOLio9V9452xGU0X5izxjqhTBqHNZSfE8KFBCe5CeJ8LL5lExch18gWM6I9jIybRbZ2mLQJjiNDnvD5UbBVgDWIcLZMf54jli7XXjFIXZzCfCta_5kNtJ9TtjinVFLIeXjt2JkAaBMjnbUoqDV7ORyOjKxhddqOvq7A9jtJ3_m2aZ5H5jUhBuUwuuSWjPbdPdIH_feNcnrp9jDGMtR1F7mdR-BU-ok6gPKzL6WVDSwXQFGUF2SyOsWtP1i0U8sH4grl4ik5aFiQc-zuScjaVk7P6osXpVxDbb0kHODi0gxPRv4UGIve6GOjzoB6HUFyO2oQq0RtjlomxMw2IMo8OyiCKdAqr6F0d-QIfT5al39hX26k_zYTBKjjb9o_ylG1K6GrDNOoOzadiD-N2-7j6hNWSc55iXKryqoZpvdgPZKa6PS25RNFs9lA7hSopLRb3XQGOX-GpA"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"token_type"</span><span class="punctuation">:</span> <span class="string">"Bearer"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"expires_in"</span><span class="punctuation">:</span> <span class="number">3600</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Wait-how-does-that-sorcery-work"><a href="#Wait-how-does-that-sorcery-work" class="headerlink" title="Wait, how does that sorcery work?"></a>Wait, how does that sorcery work?</h2><p>If you omit the custom event handlers needed to work around the non-standard aspects of Microsoft's protocol/ROPC-clone, you can see that there's actually no horrible hack required to use OpenIddict as a replacement for the default ASP.NET Core Identity API response generator.</p><p>But you might be wondering: how does that work concretely?</p><p>This "voodoo magic" (ü§£) is actually made possible by two OpenIddict features:</p><ul><li><p>A native <code>IAuthenticationHandler</code> integration: just like the ASP.NET Core cookie authentication or the OIDC client handler developed by Microsoft, OpenIddict integrates with ASP.NET Core by registering an <code>IAuthenticationHandler</code> implementation and by configuring an authentication scheme that can be called to generate a token response. By redirecting the <code>ForwardSignIn</code> to OpenIddict used by ASP.NET Core Identity, we're actually bypassing its response generation logic and replacing it by OpenIddict's logic, in a completely transparent way.</p></li><li><p>A built-in request pass-through mode: inherited from Katana's <code>OAuthAuthorizationServerMiddleware</code>, OpenIddict features a powerful pass-through mode that allows handling a token request outside the OpenIddict processing pipeline: OpenIddict starts processing the request by validating it and immediately asks ASP.NET Core to keep invoking the rest of the middleware chain so that the request can be handled in an MVC controller, in a minimal API action or in a middleware. When the application wants to return a valid token response, all it has to do is call <code>SignIn(principal, OpenIddictServerAspNetCoreDefaults.AuthenticationScheme)</code> with a <code>ClaimsPrincipal</code> instance containing the claims that will be used to create access tokens (or other types of tokens for more elaborate flows).</p></li></ul><h2 id="It-39-s-cool-but-should-I-really-do-that"><a href="#It-39-s-cool-but-should-I-really-do-that" class="headerlink" title="It's cool, but should I really do that?"></a>It's cool, but should I really do that?</h2><p>No! While this works, I wouldn't recommend using this approach. Actually, I wouldn't really recommend using the ASP.NET Core Identity API endpoints in most cases, for exactly the same reasons Andrew Lock mentioned in his <a target="_blank" rel="noopener" href="https://andrewlock.net/should-you-use-the-dotnet-8-identity-api-endpoints/">Should you use the .NET 8 Identity API endpoints?</a> post (you can't even disable each API endpoint individually! What if you don't want to let users create accounts themselves...?!)</p><p>It's also worth noting that the OAuth 2.0 resource owner password credentials grant is not the most flexible flow: it's unusable with third-party applications (since they have a direct access to the username/password, which defeats the whole purpose of using OAuth 2.0), it's incompatible with social providers authentication and passwordless authentication. In general, options like the OpenID Connect code flow are much better and much more flexible.</p></div><footer class="article-footer"><a data-url="https://kevinchalet.com/2023/10/04/can-you-use-the-asp-net-core-identity-api-endpoints-with-openiddict/" data-id="clng9ms9500brlci1fpnec4lo" class="article-share-link">Share</a> <a href="/2023/10/04/can-you-use-the-asp-net-core-identity-api-endpoints-with-openiddict/#giscus_discussion" class="article-comment-link">Comments</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asp-net-core/" rel="tag">asp.net core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/authentication/" rel="tag">authentication</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/identity/" rel="tag">identity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oauth/" rel="tag">oauth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openid-connect/" rel="tag">openid connect</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openiddict/" rel="tag">openiddict</a></li></ul></footer></div><nav id="article-nav"><a href="/2023/07/05/connecting-windows-media-center-to-tvheadend-with-hdhrproxyiptv-an-alternative-to-dvblink/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Connecting Windows Media Center to Tvheadend with HDHRProxyIPTV: an alternative to DVBLink</div></a></nav></article><section id="comments"><div id="giscus_discussion"><script src="https://giscus.app/client.js" data-repo="kevinchalet/kevinchalet.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnk2MTE2NjMwMw==" data-category="General" data-category-id="DIC_kwDOA6VS384CQu8O" data-mapping="og:title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">recents</h3><div class="widget"><ul id="recent-post" class="no-thumbnail"><li><div class="item-inner"><p class="item-title"><a href="/2023/10/04/can-you-use-the-asp-net-core-identity-api-endpoints-with-openiddict/" class="title">Can you use the ASP.NET Core Identity API endpoints with OpenIddict?</a></p><p class="item-date"><time datetime="2023-10-04T11:00:00.000Z" itemprop="datePublished">2023-10-04</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2023/07/05/connecting-windows-media-center-to-tvheadend-with-hdhrproxyiptv-an-alternative-to-dvblink/" class="title">Connecting Windows Media Center to Tvheadend with HDHRProxyIPTV: an alternative to DVBLink</a></p><p class="item-date"><time datetime="2023-07-05T18:00:00.000Z" itemprop="datePublished">2023-07-05</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2023/02/27/introducing-system-integration-support-for-the-openiddict-client/" class="title">Introducing system integration support for the OpenIddict client</a></p><p class="item-date"><time datetime="2023-02-27T16:00:00.000Z" itemprop="datePublished">2023-02-27</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2022/12/23/openiddict-4-0-general-availability/" class="title">OpenIddict 4.0 general availability</a></p><p class="item-date"><time datetime="2022-12-23T20:00:00.000Z" itemprop="datePublished">2022-12-23</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2022/12/16/getting-started-with-the-openiddict-web-providers/" class="title">Getting started with the OpenIddict web providers</a></p><p class="item-date"><time datetime="2022-12-16T15:00:00.000Z" itemprop="datePublished">2022-12-16</time></p></div></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/development/">Development</a><span class="category-list-count">33</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/general/">General</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/net/" rel="tag">.net</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/asp-net/" rel="tag">asp.net</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/asp-net-core/" rel="tag">asp.net core</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/asp-net-core-identity/" rel="tag">asp.net core identity</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnet-contrib/" rel="tag">aspnet-contrib</a><span class="tag-list-count">25</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/auth0/" rel="tag">auth0</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/authentication/" rel="tag">authentication</a><span class="tag-list-count">37</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/azure/" rel="tag">azure</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/azure-ad/" rel="tag">azure ad</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cms/" rel="tag">cms</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/component-object-model/" rel="tag">component object model</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dvblink/" rel="tag">dvblink</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hdhomerun/" rel="tag">hdhomerun</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hdhrproxytv/" rel="tag">hdhrproxytv</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/identity/" rel="tag">identity</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jwt/" rel="tag">jwt</a><span class="tag-list-count">32</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/manifest/" rel="tag">manifest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oauth/" rel="tag">oauth</a><span class="tag-list-count">37</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/okta/" rel="tag">okta</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openid/" rel="tag">openid</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openid-connect/" rel="tag">openid connect</a><span class="tag-list-count">36</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openiddict/" rel="tag">openiddict</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orchard/" rel="tag">orchard</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orchardcore/" rel="tag">orchardcore</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/owin/" rel="tag">owin</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/razor/" rel="tag">razor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tls/" rel="tag">tls</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tv/" rel="tag">tv</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tvheadend/" rel="tag">tvheadend</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uwp/" rel="tag">uwp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vulnerability/" rel="tag">vulnerability</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-authentication-broker/" rel="tag">web authentication broker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-providers/" rel="tag">web providers</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows-10/" rel="tag">windows 10</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows-media-center/" rel="tag">windows media center</a><span class="tag-list-count">2</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">9</span></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2016 - 2023 K√©vin Chalet<br>Proudly powered by <a href="http://hexo.io/" target="_blank">Hexo</a> with <a href="http://github.com/ppoffice" target="_blank">Ruipeng Zhang</a>'s <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus theme</a> and <a href="https://www.flickr.com/photos/madison_slater/" target="_blank">Madison Slater</a>'s <a href="https://www.flickr.com/photos/madison_slater/11299339856/" target="_blank">photos</a>.</div></div></footer><script src="/js/jquery.js"></script><script src="/js/script.js"></script></div></body></html>