<!DOCTYPE html><html><head><meta charset="utf-8"><title>Creating your own OpenID Connect server with ASOS: creating your own authorization provider | Kévin Chalet&#39;s blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="In this post, discover the events model used by ASOS and the rest of the ASP.NET Core security stack and how you can leverage it to control how your authorization server handles requests."><meta property="og:type" content="article"><meta property="og:title" content="Creating your own OpenID Connect server with ASOS: creating your own authorization provider"><meta property="og:url" content="https://kevinchalet.com/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/index.html"><meta property="og:site_name" content="Kévin Chalet's blog"><meta property="og:description" content="In this post, discover the events model used by ASOS and the rest of the ASP.NET Core security stack and how you can leverage it to control how your authorization server handles requests."><meta property="og:updated_time" content="2017-05-12T17:50:15.186Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Creating your own OpenID Connect server with ASOS: creating your own authorization provider"><meta name="twitter:description" content="In this post, discover the events model used by ASOS and the rest of the ASP.NET Core security stack and how you can leverage it to control how your authorization server handles requests."><meta name="twitter:creator" content="@PinpointTownes"><link rel="icon" href="/css/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css"><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-79360312-1","auto"),ga("send","pageview")</script></head></html><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><span class="site-title">Kévin Chalet&#39;s blog</span></a><nav id="main-nav"><a class="main-nav-link" href="/.">Home</a> <a class="main-nav-link" href="/archives/">Archives</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"><a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://avatars3.githubusercontent.com/u/6998306?v=3&amp;s=460"><i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"></button><input type="hidden" name="sitesearch" value="https://kevinchalet.com"></form></div></div></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"><img id="avatar" src="https://avatars3.githubusercontent.com/u/6998306?v=3&amp;s=460"><h2 id="name">Kévin Chalet</h2><h3 id="title">.NET-holic and OpenID-addict MVP in the wild.</h3><span id="location"><i class="fa fa-map-marker"></i>France</span> <a id="follow" href="https://twitter.com/intent/user?screen_name=PinpointTownes"><i class="fa fa-twitter fa-lg"></i> Follow me on Twitter</a></div><div class="article-info profile-block"><div class="article-info-block">22 <span>posts</span></div><div class="article-info-block">14 <span>tags</span></div></div><div class="contact-info profile-block"><table class="contact-list"><tr><td><a href="mailto:contact@kevinchalet.com" title="Email"><i class="fa fa-envelope"></i></a></td><td><a href="https://github.com/PinpointTownes" title="GitHub"><i class="fa fa-github"></i></a></td><td><a href="https://twitter.com/PinpointTownes" title="Twitter"><i class="fa fa-twitter"></i></a></td><td><a href="http://stackoverflow.com/users/542757/pinpoint" title="StackOverflow"><i class="fa fa-stack-overflow"></i></a></td><td><a href="https://mvp.microsoft.com/fr-fr/PublicProfile/5001682" title="Microsoft MVP"><i class="fa fa-windows"></i></a></td><td><a href="/atom.xml" title="RSS"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">Creating your own OpenID Connect server with ASOS: creating your own authorization provider</h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/"><time datetime="2016-07-13T15:45:00.000Z" itemprop="datePublished">2016-07-13</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/development/">Development</a></div></div></header><div class="article-entry" itemprop="articleBody"><div class="note tip"><p>This post is the fourth part of a series of blog posts entitled <strong>Creating your own OpenID Connect server with ASOS</strong>:</p><ol><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-introduction/" title="Introduction">Introduction</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/" title="Choosing the right flow(s)">Choosing the right flow(s)</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/" title="Registering the middleware in the ASP.NET Core pipeline">Registering the middleware in the ASP.NET Core pipeline</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/" title="Creating your own authorization provider">Creating your own authorization provider</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/" title="Implementing the resource owner password credentials grant">Implementing the resource owner password credentials grant</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-authorization-code-and-implicit-flows/" title="Implementing the authorization code and implicit flows">Implementing the authorization code and implicit flows</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-adding-custom-claims-and-granting-scopes/" title="Adding custom claims and granting scopes">Adding custom claims and granting scopes</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-testing-your-authorization-server-with-postman/" title="Testing your authorization server with Postman">Testing your authorization server with Postman</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-conclusion/" title="Conclusion">Conclusion</a></li></ol></div><p><strong>ASOS leverages the same events model as the rest of the ASP.NET Core security stack</strong>: often hard to understand for beginners, this pattern (inherited from OWIN/Katana) proved to be extremely powerful by offering full flexibility on the request processing.</p><p>To help make things clearer before trying to implement a concrete flow, here&#39;s a quick overview of how it works with ASOS:</p><hr><h2 id="OpenIdConnectServerProvider-and-the-events-model"><a href="#OpenIdConnectServerProvider-and-the-events-model" class="headerlink" title="OpenIdConnectServerProvider and the events model"></a><code>OpenIdConnectServerProvider</code> and the events model</h2><p><code>OpenIdConnectServerProvider</code> is ASOS&#39; main extensibility hook: its methods (named events or notifications) are invoked by <code>OpenIdConnectServerHandler</code> for every OpenID Connect request to give you a chance to control how the request is handled. Depending on the flows you want to support, you&#39;ll need to implement different events.</p><p><strong>You have 2 options to create your own provider</strong>:</p><ul><li>Directly instantiante an <code>OpenIdConnectServerProvider</code> and use inline delegates. This approach is perfect when implementing a simple server that mainly relies on hardcoded values.</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">app.UseOpenIdConnectServer(options =&gt;</div><div class="line">&#123;</div><div class="line">    options.Provider = <span class="keyword">new</span> OpenIdConnectServerProvider</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// Implement OnValidateAuthorizationRequest to</span></div><div class="line">        <span class="comment">// support interactive flows (code/implicit/hybrid).</span></div><div class="line">        OnValidateAuthorizationRequest = <span class="keyword">async</span> context =&gt; &#123; ... &#125;,</div><div class="line"></div><div class="line">        <span class="comment">// Implement OnValidateTokenRequest to support flows using the token endpoint</span></div><div class="line">        <span class="comment">// (code/refresh token/password/client credentials/custom grant).</span></div><div class="line">        OnValidateTokenRequest = <span class="keyword">async</span> context =&gt; &#123; ... &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>You can also directly set the events properties without having to manually instantiate a <code>OpenIdConnectServerProvider</code>, as ASOS always registers a default <code>OpenIdConnectServerProvider</code> instance for you:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">app.UseOpenIdConnectServer(options =&gt;</div><div class="line">&#123;</div><div class="line">    <span class="comment">// Implement OnValidateAuthorizationRequest to</span></div><div class="line">    <span class="comment">// support interactive flows (code/implicit/hybrid).</span></div><div class="line">    options.Provider.OnValidateAuthorizationRequest = <span class="keyword">async</span> context =&gt; &#123; ... &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Implement OnValidateTokenRequest to support flows using the token endpoint</span></div><div class="line">    <span class="comment">// (code/refresh token/password/client credentials/custom grant).</span></div><div class="line">    options.Provider.OnValidateTokenRequest = <span class="keyword">async</span> context =&gt; &#123; ... &#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure><ul><li>Create your own subclass of <code>OpenIdConnectServerProvider</code> and override the virtual methods you want to implement. This is clearly the best approach when implementing a more complex authorization server.</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">AuthorizationProvider</span> : <span class="title">OpenIdConnectServerProvider</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Implement OnValidateAuthorizationRequest to support interactive flows (code/implicit/hybrid).</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">ValidateAuthorizationRequest</span>(<span class="params">ValidateAuthorizationRequestContext context</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Implement OnValidateTokenRequest to support flows using the token endpoint</span></div><div class="line">    <span class="comment">// (code/refresh token/password/client credentials/custom grant).</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">ValidateTokenRequest</span>(<span class="params">ValidateTokenRequestContext context</span>) </span>&#123; ... &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.UseOpenIdConnectServer(options =&gt;</div><div class="line">&#123;</div><div class="line">    options.Provider = <span class="keyword">new</span> AuthorizationProvider();</div><div class="line">&#125;);</div></pre></td></tr></table></figure><div class="note info"><p>It&#39;s important to note that the authorization provider is always a singleton: <strong>don&#39;t try to inject scoped dependencies in its constructor</strong>. To resolve scoped dependencies (e.g an Entity Framework <code>DbContext</code>), use the <code>context.HttpContext.RequestServices</code> property to access the scoped container.</p><p>You can read <a href="https://github.com/aspnet/Options/issues/11" target="_blank" rel="external">this thread</a> for more information about this limitation/design choice, which is not specific to ASOS and impacts all the security middleware sharing the same events model. It might be <a href="https://github.com/aspnet-contrib/AspNet.Security.OpenIdConnect.Server/issues/275" target="_blank" rel="external">fixed in a future version</a>, though.</p></div><a id="more"></a><hr><h2 id="Working-with-the-different-categories-of-events"><a href="#Working-with-the-different-categories-of-events" class="headerlink" title="Working with the different categories of events"></a>Working with the different categories of events</h2><p>ASOS has 5 different categories of events:</p><ul><li>The events called to <strong>extract or restore an OpenID Connect request from an HTTP request</strong> (e.g <code>ExtractAuthorizationRequest</code>).</li><li>The events responsible of <strong>validating requests</strong> (e.g <code>ValidateAuthorizationRequest</code>).</li><li>The events <strong>handling requests</strong> (e.g <code>HandleAuthorizationRequest</code>).</li><li>The events that can be used to <strong>alter or replace the response</strong> before it is returned to the caller (e.g <code>ApplyAuthorizationResponse</code>).</li><li>The events in charge of <strong>serializing and deserializing tokens</strong> (e.g <code>SerializeAccessToken</code>).</li></ul><hr><h3 id="Request-extraction-events"><a href="#Request-extraction-events" class="headerlink" title="Request extraction events"></a>Request extraction events</h3><p>Immediately after validating the HTTP method and extracting the request parameters from the query string or from the request form (depending on the endpoint type), ASOS invokes one of the <code>Extract*Request</code> events to give you a chance to manually replace, restore or alter the request before it is validated.</p><p>For instance, <code>ExtractAuthorizationRequest</code> can be used to restore an OpenID Connect authorization request from the user session, which can be useful if you need to save POST or large GET authorization requests before redirecting the user to an external provider:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Task <span class="title">ExtractAuthorizationRequest</span>(<span class="params">ExtractAuthorizationRequestContext context</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// If a request_id parameter can be found in the authorization request,</span></div><div class="line">    <span class="comment">// restore the complete authorization request stored in the user session.</span></div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(context.Request.RequestId))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> payload = context.HttpContext.Session.Get(context.Request.RequestId);</div><div class="line">        <span class="keyword">if</span> (payload == <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            context.Reject(</div><div class="line">                error: OpenIdConnectConstants.Errors.InvalidRequest,</div><div class="line">                description: <span class="string">"Invalid request: timeout expired."</span>);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> Task.FromResult(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Restore the authorization request parameters from the serialized payload.</span></div><div class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> reader = <span class="keyword">new</span> BsonReader(<span class="keyword">new</span> MemoryStream(payload)))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> parameter <span class="keyword">in</span> JObject.Load(reader))</div><div class="line">            &#123;</div><div class="line">                <span class="comment">// Avoid overriding the current request parameters.</span></div><div class="line">                <span class="keyword">if</span> (context.Request.HasParameter(parameter.Key))</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                context.Request.SetParameter(parameter.Key, parameter.Value);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Task.FromResult(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Another concrete use case is when you have to support non-standard clients that don&#39;t send the parameters required by the OAuth2/OIDC specifications, as <code>ExtractAuthorizationRequest</code> can be used to remove, replace or even add a missing parameter before ASOS starts validating the request:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">ExtractAuthorizationRequest</span>(<span class="params">ExtractAuthorizationRequestContext context</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> database = context.HttpContext.RequestServices.GetRequiredService&lt;ApplicationContext&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// If the mandatory response_type parameter is missing, infer it from</span></div><div class="line">    <span class="comment">// the client application type corresponding to the client_id parameter.</span></div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(context.Request.ClientId) &amp;&amp;</div><div class="line">         <span class="keyword">string</span>.IsNullOrEmpty(context.Request.ResponseType))</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// Retrieve the application details corresponding to the requested client_id.</span></div><div class="line">        <span class="keyword">var</span> application = <span class="keyword">await</span> (<span class="keyword">from</span> entity <span class="keyword">in</span> database.Applications</div><div class="line">                                 <span class="keyword">where</span> entity.ApplicationID == context.Request.ClientId</div><div class="line">                                 <span class="keyword">select</span> entity).SingleOrDefaultAsync();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (application != <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// If the application is a JS app, use the implicit flow. Else, use the code flow.</span></div><div class="line">            context.Request.ResponseType = application.Type == ApplicationType.JavaScript ?</div><div class="line">                OpenIdConnectConstants.ResponseTypes.Token :</div><div class="line">                OpenIdConnectConstants.ResponseTypes.Code;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h3 id="Request-validation-events"><a href="#Request-validation-events" class="headerlink" title="Request validation events"></a>Request validation events</h3><p>Implementing validation events is <em>generally</em> required to allow ASOS to process OpenID Connect requests. It&#39;s particularly true with <code>ValidateAuthorizationRequest</code> and <code>ValidateTokenRequest</code>, that must be implemented to support interactive and non-interactive flows.</p><p>To allow full flexibility, <strong>ASOS always gives you 2 or 3 options</strong>, depending on the exact event you&#39;re implementing:</p><ul><li><strong>Validate the request</strong>: it&#39;s typically what you&#39;ll want to do after checking that the request was fully valid (e.g the client application was allowed to use the requested grant type and its client credentials were valid).</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">context.Validate();</div></pre></td></tr></table></figure><div class="note warn"><p>When implementing <code>ValidateTokenRequest</code>, <strong><code>context.Validate()</code> shouldn&#39;t be called for public applications like JS, mobile or desktop apps</strong>. If you want to make client authentication optional, <strong>consider using <code>context.Skip()</code> instead</strong>, as explained below.</p></div><ul><li><strong>Reject the request</strong>: when the request doesn&#39;t meet your specific requirements (e.g the client credentials are missing or invalid), you can reject it with an error code and a description explaining why the request was rejected.</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">context.Reject(</div><div class="line">    error: OpenIdConnectConstants.Errors.UnauthorizedClient,</div><div class="line">    description: <span class="string">"This client application is not allowed to use the implicit flow."</span>);</div></pre></td></tr></table></figure><ul><li><strong>Skip validation</strong>: under certain circumstances, ASOS allows you to skip request validation. Calling <code>context.Skip()</code> informs ASOS that the request was not fully validated (e.g because the client credentials were missing) but should be accepted nevertheless.</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">context.Skip();</div></pre></td></tr></table></figure><p>At the time of writing, only <code>ValidateIntrospectionRequest</code>, <code>ValidateRevocationRequest</code> and <code>ValidateTokenRequest</code> allow using <code>context.Skip()</code>, to make client authentication optional.</p><div class="note warn"><p>Though particularly useful when using the resource owner password credentials grant with JS applications, <strong>that&#39;s something you should avoid</strong> when dealing with <strong>confidential applications using the authorization code flow</strong>, as it drastically reduces the overall security level.</p></div><p>Here&#39;s an example of how <code>ValidateTokenRequest</code> can be implemented to reject specific grant types while allowing all your client applications to use the token endpoint without having to authenticate:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Task <span class="title">ValidateTokenRequest</span>(<span class="params">ValidateTokenRequestContext context</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Reject the token request that don't use grant_type=password or grant_type=refresh_token.</span></div><div class="line">    <span class="keyword">if</span> (!context.Request.IsPasswordGrantType() &amp;&amp; !context.Request.IsRefreshTokenGrantType())</div><div class="line">    &#123;</div><div class="line">        context.Reject(</div><div class="line">            error: OpenIdConnectConstants.Errors.UnsupportedGrantType,</div><div class="line">            description: <span class="string">"Only resource owner password credentials and refresh token "</span> +</div><div class="line">                         <span class="string">"are accepted by this authorization server"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> Task.FromResult(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Since there's only one application and since it's a public client</span></div><div class="line">    <span class="comment">// (i.e a client that cannot keep its credentials private), call Skip()</span></div><div class="line">    <span class="comment">// to inform the server the request should be accepted without </span></div><div class="line">    <span class="comment">// enforcing client authentication.</span></div><div class="line">    context.Skip();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Task.FromResult(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><div class="note tip"><p>More samples can be found in the <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/" title="next part">next part</a>, that explains how to implement the <code>ValidateTokenRequest</code> event to support the resource owner password credentials grant with different scenarios.</p></div><hr><h3 id="Request-handling-events"><a href="#Request-handling-events" class="headerlink" title="Request handling events"></a>Request handling events</h3><p>Implementing these events is generally not required, but can be useful to control how ASOS handles a request. Similarly to what the security middleware built in ASP.NET Core offer, you have 3 options to control the request processing:</p><ul><li><strong>Let ASOS determine how the request will be processed</strong>: in most cases, you&#39;ll simply want to add your own logic determining what will be returned to the caller and let ASOS handle the rest of the request. For instance, you may want to implement the <code>HandleUserinfoRequest</code> event to update, augment, replace or remove the default claims returned by the userinfo endpoint:</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Task <span class="title">HandleUserinfoRequest</span>(<span class="params">HandleUserinfoRequestContext context</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// You can retrieve the claims stored in the access token extracted</span></div><div class="line">    <span class="comment">// from the userinfo request by accessing the authentication ticket.</span></div><div class="line">    <span class="keyword">var</span> principal = context.Ticket.Principal;</div><div class="line"></div><div class="line">    <span class="comment">// Set family_name, given_name, birth_date using custom claims:</span></div><div class="line">    context.FamilyName = principal.FindClaim(<span class="string">"custom:last_name"</span>)?.Value;</div><div class="line">    context.GivenName = principal.FindClaim(<span class="string">"custom:first_name"</span>)?.Value;</div><div class="line">    context.BirthDate = principal.FindClaim(<span class="string">"custom:birth_date"</span>)?.Value;</div><div class="line"></div><div class="line">    <span class="comment">// Only expose "custom-claim" if "custom-scope" was granted by the resource owner.</span></div><div class="line">    <span class="keyword">if</span> (context.Ticket.HasScope(<span class="string">"custom-scope"</span>))</div><div class="line">    &#123;</div><div class="line">        context.Claims[<span class="string">"custom-claim"</span>] = <span class="string">"claim-value"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Task.FromResult(<span class="number">0</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>Handle the request manually</strong>: by calling <code>context.HandleRequest()</code>, you can inform ASOS that its default logic should not be executed and that the request should terminate immediately after invoking your event handler. In doing so, you take full control over the response: you can return a custom status code, render a HTML page or even send back a JSON payload by directly writing to the HTTP response stream.</li></ul><p>Here&#39;s an example implementing <code>HandleAuthorizationRequest</code> to immediately return a token to the client application without displaying a consent page or relying on ASP.NET Core MVC to render it (if the user is not already logged in, <code>ChallengeAsync</code> is immediately called to redirect him/her to Google&#39;s authorization endpoint):</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">HandleAuthorizationRequest</span>(<span class="params">HandleAuthorizationRequestContext context</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Retrieve the principal extracted from the local cookie. If user is not already logged in, a null value is returned.</span></div><div class="line">    <span class="keyword">var</span> principal = <span class="keyword">await</span> context.HttpContext.Authentication.AuthenticateAsync(CookieAuthenticationDefaults.AuthenticationScheme);</div><div class="line">    <span class="keyword">if</span> (principal == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// Redirect the user to the Google authorization/authentication page.</span></div><div class="line">        <span class="keyword">await</span> context.HttpContext.Authentication.ChallengeAsync(GoogleDefaults.AuthenticationScheme);</div><div class="line"></div><div class="line">        <span class="comment">// Mark the response as handled to skip the default request processing.</span></div><div class="line">        context.HandleResponse();</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> identity = <span class="keyword">new</span> ClaimsIdentity(context.Options.AuthenticationScheme);</div><div class="line">    identity.AddClaim(OpenIdConnectConstants.Claims.Subject, <span class="string">"3B181511-9C18-4EEB-A80E-9E48BB0E0872"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Create a new authentication ticket holding the user identity.</span></div><div class="line">    <span class="keyword">var</span> ticket = <span class="keyword">new</span> AuthenticationTicket(</div><div class="line">        <span class="keyword">new</span> ClaimsPrincipal(identity),</div><div class="line">        <span class="keyword">new</span> AuthenticationProperties(),</div><div class="line">        context.Options.AuthenticationScheme);</div><div class="line"></div><div class="line">    <span class="comment">// Call SignInAsync to create and return a new authorization response containing the serialized code/tokens.</span></div><div class="line">    <span class="comment">// The user will be automatically redirected back to the client application with the authorization code/access token.</span></div><div class="line">    <span class="keyword">await</span> context.HttpContext.Authentication.SignInAsync(ticket.AuthenticationScheme, ticket.Principal, ticket.Properties);</div><div class="line"></div><div class="line">    <span class="comment">// Mark the response as handled to skip the default request processing.</span></div><div class="line">    context.HandleResponse();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>Skip the default logic and delegate the request handling to the next middleware in the pipeline:</strong> when calling <code>context.SkipToNextMiddleware()</code>, ASOS is informed that the default request processing should not be applied.</li></ul><p>Unlike <code>context.HandleResponse()</code>, <code>context.SkipToNextMiddleware()</code> doesn&#39;t immediately stop the request processing. Instead, the next middleware in the pipeline (i.e all the middleware registered after <code>app.UseOpenIdConnectServer()</code>) are invoked to give them a chance to handle the request.</p><p>A common use case is when you want to handle the userinfo request in your own API controller instead of handling it at the middleware level:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Task <span class="title">HandleUserinfoRequest</span>(<span class="params">HandleUserinfoRequestContext context</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Note: by default, the OpenID Connect server middleware automatically handles</span></div><div class="line">    <span class="comment">// userinfo requests and directly writes the JSON response to the response stream.</span></div><div class="line">    <span class="comment">// Calling context.SkipToNextMiddleware() bypasses the default request processing</span></div><div class="line">    <span class="comment">// and delegates it to a custom ASP.NET Core MVC controller (UserinfoController).</span></div><div class="line">    context.SkipToNextMiddleware();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Task.FromResult(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserinfoController</span> : <span class="title">Controller</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Specify ActiveAuthenticationSchemes = "Bearer" to ensure the principal extracted from</span></div><div class="line">    <span class="comment">// the access token sent by the client application is correctly attached to the HTTP context.</span></div><div class="line">    [Authorize(ActiveAuthenticationSchemes = OAuthValidationDefaults.AuthenticationScheme)]</div><div class="line">    [HttpGet(<span class="string">"~/connect/userinfo"</span>)]</div><div class="line">    <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Get</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> Json(<span class="keyword">new</span></div><div class="line">        &#123;</div><div class="line">            sub = User.GetClaim(OpenIdConnectConstants.Claims.Subject),</div><div class="line">            name = User.GetClaim(OpenIdConnectConstants.Claims.Name)</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h3 id="Response-events"><a href="#Response-events" class="headerlink" title="Response events"></a>Response events</h3><p>Similarly to how the request handling events work, the <code>Apply*Response</code> events give you a chance to control how the OpenID Connect responses are serialized and applied just before they are returned to the caller: you can call <code>context.HandleResponse()</code> to inform ASOS that the response should be processed using your own logic or <code>context.SkipToNextMiddleware()</code> to bypass the default response logic and to invoke the next middleware.</p><p>Here&#39;s an implementation of <code>ApplyTokenResponse</code> that adds a custom parameter to the token response before returning it:</p><div class="note info"><p>Note that this practice is usually discouraged when using it as a way to flow user attributes. Instead, <a href="http://stackoverflow.com/a/36581160/542757" target="_blank" rel="external">consider storing them as claims in the identity token</a>.</p></div><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Task <span class="title">ApplyTokenResponse</span>(<span class="params">ApplyTokenResponseContext context</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Only add the custom parameter if the response indicates a successful response.</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(context.Error))</div><div class="line">    &#123;</div><div class="line">        context.Response[<span class="string">"custom-parameter"</span>] = <span class="string">"value"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Task.FromResult(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><p>Next part: <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/" title="Implementing the resource owner password credentials grant">Implementing the resource owner password credentials grant</a>.</p></div><footer class="article-footer"><a data-url="https://kevinchalet.com/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/" data-id="cjj4grscu001jesi29cutvx9y" class="article-share-link">Share</a> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/#disqus_thread" class="article-comment-link">Comments</a><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asp-net-core/">asp.net core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnet-contrib/">aspnet-contrib</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/authentication/">authentication</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jwt/">jwt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oauth/">oauth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openid-connect/">openid connect</a></li></ul></footer></div><nav id="article-nav"><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">Creating your own OpenID Connect server with ASOS: implementing the resource owner password credentials grant</div></a><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Creating your own OpenID Connect server with ASOS: registering the middleware in the ASP.NET Core pipeline</div></a></nav></article><section id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">recents</h3><div class="widget"><ul id="recent-post" class="no-thumbnail"><li><div class="item-inner"><p class="item-title"><a href="/2018/07/02/implementing-advanced-scenarios-using-the-new-openiddict-rc3-events-model/" class="title">Implementing advanced scenarios using the new OpenIddict RC3 events model</a></p><p class="item-date"><time datetime="2018-07-02T16:15:00.000Z" itemprop="datePublished">2018-07-02</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2018/06/20/openiddict-rc3-is-out/" class="title">OpenIddict RC3 is out</a></p><p class="item-date"><time datetime="2018-06-20T14:00:00.000Z" itemprop="datePublished">2018-06-20</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2018/06/18/the-aspnet-contrib-oauth-2-0-openid-2-0-social-providers-are-now-rtm/" class="title">The aspnet-contrib OAuth 2.0/OpenID 2.0 social providers are now RTM</a></p><p class="item-date"><time datetime="2018-06-18T20:00:00.000Z" itemprop="datePublished">2018-06-18</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2018/02/19/openiddict-rc2-is-now-on-nuget-org/" class="title">OpenIddict RC2 is now on NuGet.org</a></p><p class="item-date"><time datetime="2018-02-19T18:00:00.000Z" itemprop="datePublished">2018-02-19</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2018/01/09/why-you-should-never-use-html-raw-in-your-razor-views/" class="title">Why you should never use Html.Raw in your Razor views</a></p><p class="item-date"><time datetime="2018-01-09T18:30:00.000Z" itemprop="datePublished">2018-01-09</time></p></div></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/development/">Development</a><span class="category-list-count">22</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">tags</h3><div class="widget"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/asp-net-core/">asp.net core</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnet-contrib/">aspnet-contrib</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/authentication/">authentication</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/azure/">azure</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jwt/">jwt</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oauth/">oauth</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openid/">openid</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openid-connect/">openid connect</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openiddict/">openiddict</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/razor/">razor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uwp/">uwp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vulnerability/">vulnerability</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-authentication-broker/">web authentication broker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows-10/">windows 10</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">9</span></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2016 - 2018 Kévin Chalet<br>Proudly powered by <a href="http://hexo.io/" target="_blank">Hexo</a> with <a href="http://github.com/ppoffice" target="_blank">Ruipeng Zhang</a>'s <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus theme</a> and <a href="https://www.flickr.com/photos/madison_slater/" target="_blank">Madison Slater</a>'s <a href="https://www.flickr.com/photos/madison_slater/11299339856/" target="_blank">photos</a>.</div></div></footer><script>var disqus_shortname="kevinchalet";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script src="/js/jquery.js"></script><script src="/js/script.js"></script></div></body>