<!DOCTYPE html><html><head><meta charset="utf-8"><title>Kévin Chalet&#39;s blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description"><meta property="og:type" content="website"><meta property="og:title" content="Kévin Chalet's blog"><meta property="og:url" content="http://kevinchalet.com/page/2/index.html"><meta property="og:site_name" content="Kévin Chalet's blog"><meta property="og:description"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Kévin Chalet's blog"><meta name="twitter:description"><meta name="twitter:creator" content="@PinpointTownes"><link rel="icon" href="/css/images/favicon.ico"><link rel="stylesheet" href="/css/style.css" type="text/css"><link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css"><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-79360312-1","auto"),ga("send","pageview");</script></head></html><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><span class="site-title">Kévin Chalet&#39;s blog</span></a><nav id="main-nav"><a class="main-nav-link" href="/.">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"><a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://avatars3.githubusercontent.com/u/6998306?v=3&amp;s=460"><i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"></button><input type="hidden" name="sitesearch" value="http://kevinchalet.com"></form></div></div></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"><img id="avatar" src="https://avatars3.githubusercontent.com/u/6998306?v=3&amp;s=460"><h2 id="name">Kévin Chalet</h2><h3 id="title">.NET-holic and OpenID-addict MVP in the wild.</h3><span id="location"><i class="fa fa-map-marker"></i>France</span> <a id="follow" href="https://twitter.com/intent/user?screen_name=PinpointTownes"><i class="fa fa-twitter fa-lg"></i> Follow me on Twitter</a></div><div class="article-info profile-block"><div class="article-info-block">10 <span>posts</span></div><div class="article-info-block">9 <span>tags</span></div></div><div class="contact-info profile-block"><table class="contact-list"><tr><td><a href="https://github.com/PinpointTownes" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td><td><a href="https://twitter.com/PinpointTownes" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td><td><a href="http://stackoverflow.com/users/542757/pinpoint" target="_blank" title="StackOverflow"><i class="fa fa-stack-overflow"></i></a></td><td><a href="https://mvp.microsoft.com/fr-fr/PublicProfile/5001682" target="_blank" title="Microsoft MVP"><i class="fa fa-windows"></i></a></td><td><a href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/">Creating your own OpenID Connect server with ASOS: implementing the resource owner password credentials grant</a></h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/"><time datetime="2016-07-13T16:00:00.000Z" itemprop="datePublished">2016-07-13</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/development/">Development</a></div></div></header><div class="article-entry" itemprop="articleBody"><div class="note tip"><p>This post is the fifth part of a series of blog posts entitled <strong>Creating your own OpenID Connect server with ASOS</strong>:</p><ol><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-introduction/" title="Introduction">Introduction</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/" title="Choosing the right flow(s)">Choosing the right flow(s)</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/" title="Registering the middleware in the ASP.NET Core pipeline">Registering the middleware in the ASP.NET Core pipeline</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/" title="Creating your own authorization provider">Creating your own authorization provider</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/" title="Implementing the resource owner password credentials grant">Implementing the resource owner password credentials grant</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-authorization-code-and-implicit-flows/" title="Implementing the authorization code and implicit flows">Implementing the authorization code and implicit flows</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-adding-custom-claims-and-granting-scopes/" title="Adding custom claims and granting scopes">Adding custom claims and granting scopes</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-testing-your-authorization-server-with-postman/" title="Testing your authorization server with Postman">Testing your authorization server with Postman</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-conclusion/" title="Conclusion">Conclusion</a></li></ol></div><p>Implementing the resource owner password credentials grant (abbreviated <code>ROPC</code> for brevity) is quite easy with ASOS as the only thing you have to do is to provide your own implementation of <code>ValidateTokenRequest</code> and <code>HandleTokenRequest</code>.</p><p>But to properly implement these events, you first need to determine what&#39;s the best client authentication policy for your application.</p><hr><h2 id="Implementing_ValidateTokenRequest_to_validate_the_grant_type_and_the_client_application_credentials"><a href="#Implementing_ValidateTokenRequest_to_validate_the_grant_type_and_the_client_application_credentials" class="headerlink" title="Implementing ValidateTokenRequest to validate the grant type and the client application credentials"></a>Implementing <code>ValidateTokenRequest</code> to validate the grant type and the client application credentials</h2><p>When implementing flows using backchannel communication (i.e resource owner password credentials grant, client credentials grant, authorization code flow or refresh token grant), the <code>ValidateTokenRequest</code> event must be overridden to validate the token request.</p><p>So, what are you supposed to validate in this event? Mainly two things:</p><ul><li><strong>The grant type</strong>: in most cases, you&#39;ll likely want to restrict the grants a client application is allowed to use (e.g resource owner password credentials only): <code>ValidateTokenRequest</code> is the best place for that.</li></ul><div class="note info"><p>It should be noted that ASOS doesn&#39;t validate the <code>grant_type</code> value, <a href="https://tools.ietf.org/html/rfc6749#section-4.5">that can even contain a custom value for extension grants</a>: if you only want to support standard grants, it&#39;s up to you to reject the token request by calling <code>context.Reject()</code>.</p><p><code>IsAuthorizationCodeGrantType()</code>, <code>IsRefreshTokenGrantType()</code>, <code>IsPasswordGrantType()</code> and <code>IsClientCredentialsGrantType()</code> can be used for this exact purpose.</p></div><ul><li><strong>The client credentials</strong> (<code>client_id</code>/<code>client_secret</code>): the OAuth2 specification explicitly states <strong>that confidential applications</strong> (i.e applications that are able to keep their credentials secret, like server-side apps) <strong>must authenticate when using the token endpoint</strong>. This security measure is extremely important as it&#39;s the only way to prevent malicious applications from retrieving an access token on behalf of a legitimate confidential application.</li></ul><div class="note info"><p>Contrary to popular belief, client authentication is never mandatory when using the token endpoint (except for the client credentials grant), which means that <strong>public applications like JS or mobile apps are allowed to use the resource owner password grant without having to send their credentials</strong>.</p><p>In practice, it&#39;s up to you to decide whether your token endpoint should accept unauthenticated requests or not, depending on the type of client you&#39;ll use.</p></div><p class="article-more-link"><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/">Read more</a></p></div><footer class="article-footer"><a data-url="http://kevinchalet.com/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/" data-id="cis3b6p1k001dz8i2v2udl9ql" class="article-share-link">Share</a> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/#disqus_thread" class="article-comment-link">Comments</a><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asp-net-core/">asp.net core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnet-contrib/">aspnet-contrib</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/authentication/">authentication</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jwt/">jwt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oauth/">oauth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openid-connect/">openid connect</a></li></ul></footer></div></article><article id="post-creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/">Creating your own OpenID Connect server with ASOS: creating your own authorization provider</a></h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/"><time datetime="2016-07-13T15:45:00.000Z" itemprop="datePublished">2016-07-13</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/development/">Development</a></div></div></header><div class="article-entry" itemprop="articleBody"><div class="note tip"><p>This post is the fourth part of a series of blog posts entitled <strong>Creating your own OpenID Connect server with ASOS</strong>:</p><ol><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-introduction/" title="Introduction">Introduction</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/" title="Choosing the right flow(s)">Choosing the right flow(s)</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/" title="Registering the middleware in the ASP.NET Core pipeline">Registering the middleware in the ASP.NET Core pipeline</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/" title="Creating your own authorization provider">Creating your own authorization provider</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/" title="Implementing the resource owner password credentials grant">Implementing the resource owner password credentials grant</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-authorization-code-and-implicit-flows/" title="Implementing the authorization code and implicit flows">Implementing the authorization code and implicit flows</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-adding-custom-claims-and-granting-scopes/" title="Adding custom claims and granting scopes">Adding custom claims and granting scopes</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-testing-your-authorization-server-with-postman/" title="Testing your authorization server with Postman">Testing your authorization server with Postman</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-conclusion/" title="Conclusion">Conclusion</a></li></ol></div><p><strong>ASOS leverages the same events model as the rest of the ASP.NET Core security stack</strong>: often hard to understand for beginners, this pattern (inherited from OWIN/Katana) proved to be extremely powerful by offering full flexibility on the request processing.</p><p>To help make things clearer before trying to implement a concrete flow, here&#39;s a quick overview of how it works with ASOS:</p><hr><h2 id="OpenIdConnectServerProvider_and_the_events_model"><a href="#OpenIdConnectServerProvider_and_the_events_model" class="headerlink" title="OpenIdConnectServerProvider and the events model"></a><code>OpenIdConnectServerProvider</code> and the events model</h2><p><code>OpenIdConnectServerProvider</code> is ASOS&#39; main extensibility hook: its methods (named events or notifications) are invoked by <code>OpenIdConnectServerHandler</code> for every OpenID Connect request to give you a chance to control how the request is handled. Depending on the flows you want to support, you&#39;ll need to implement different events.</p><p><strong>You have 2 options to create your own provider</strong>:</p><ul><li>Directly instantiante an <code>OpenIdConnectServerProvider</code> and use inline delegates. This approach is perfect when implementing a simple server that mainly relies on hardcoded values.</li></ul><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">app.UseOpenIdConnectServer(options =&gt; &#123;</span><br><span class="line">    options.Provider = <span class="keyword">new</span> OpenIdConnectServerProvider &#123;</span><br><span class="line">        <span class="comment">// Implement OnValidateAuthorizationRequest to</span></span><br><span class="line">        <span class="comment">// support interactive flows (code/implicit/hybrid).</span></span><br><span class="line">        OnValidateAuthorizationRequest = <span class="keyword">async</span> context =&gt; &#123; ... &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Implement OnValidateTokenRequest to support flows using the token endpoint</span></span><br><span class="line">        <span class="comment">// (code/refresh token/password/client credentials/custom grant).</span></span><br><span class="line">        OnValidateTokenRequest = <span class="keyword">async</span> context =&gt; &#123; ... &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>Create your own subclass of <code>OpenIdConnectServerProvider</code> and override the virtual methods you want to implement. This is clearly the best approach when implementing a more complex authorization server.</li></ul><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">AuthorizationProvider</span> : <span class="title">OpenIdConnectServerProvider</span> &#123;</span><br><span class="line">    <span class="comment">// Implement OnValidateAuthorizationRequest to support interactive flows (code/implicit/hybrid).</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">ValidateTokenRequest</span>(<span class="params">ValidateTokenRequestContext context</span>) </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Implement OnValidateTokenRequest to support flows using the token endpoint</span></span><br><span class="line">    <span class="comment">// (code/refresh token/password/client credentials/custom grant).</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">ValidateAuthorizationRequest</span>(<span class="params">ValidateAuthorizationRequestContext context</span>) </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">app.UseOpenIdConnectServer(options =&gt; &#123;</span><br><span class="line">    options.Provider = <span class="keyword">new</span> AuthorizationProvider();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><div class="note info"><p>It&#39;s important to note that the authorization provider is always a singleton: <strong>don&#39;t try to inject scoped dependencies in its constructor</strong>. To resolve scoped dependencies (e.g an Entity Framework <code>DbContext</code>), use the <code>context.HttpContext.RequestServices</code> property to access the scoped container.</p><p>You can read <a href="https://github.com/aspnet/Options/issues/11">this thread</a> for more information about this limitation/design choice, which is not specific to ASOS and impacts all the security middleware sharing the same events model. It might be <a href="https://github.com/aspnet-contrib/AspNet.Security.OpenIdConnect.Server/issues/275">fixed in a future version</a>, though.</p></div><p class="article-more-link"><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/">Read more</a></p></div><footer class="article-footer"><a data-url="http://kevinchalet.com/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/" data-id="cis3b6p1t001tz8i2jmc30jcm" class="article-share-link">Share</a> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/#disqus_thread" class="article-comment-link">Comments</a><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asp-net-core/">asp.net core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnet-contrib/">aspnet-contrib</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/authentication/">authentication</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jwt/">jwt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oauth/">oauth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openid-connect/">openid connect</a></li></ul></footer></div></article><article id="post-creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/">Creating your own OpenID Connect server with ASOS: registering the middleware in the ASP.NET Core pipeline</a></h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/"><time datetime="2016-07-13T15:30:00.000Z" itemprop="datePublished">2016-07-13</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/development/">Development</a></div></div></header><div class="article-entry" itemprop="articleBody"><div class="note tip"><p>This post is the third part of a series of blog posts entitled <strong>Creating your own OpenID Connect server with ASOS</strong>:</p><ol><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-introduction/" title="Introduction">Introduction</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/" title="Choosing the right flow(s)">Choosing the right flow(s)</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/" title="Registering the middleware in the ASP.NET Core pipeline">Registering the middleware in the ASP.NET Core pipeline</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/" title="Creating your own authorization provider">Creating your own authorization provider</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/" title="Implementing the resource owner password credentials grant">Implementing the resource owner password credentials grant</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-authorization-code-and-implicit-flows/" title="Implementing the authorization code and implicit flows">Implementing the authorization code and implicit flows</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-adding-custom-claims-and-granting-scopes/" title="Adding custom claims and granting scopes">Adding custom claims and granting scopes</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-testing-your-authorization-server-with-postman/" title="Testing your authorization server with Postman">Testing your authorization server with Postman</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-conclusion/" title="Conclusion">Conclusion</a></li></ol></div><p>In the previous post (<a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/" title="Choosing the right flow(s)">Choosing the right flow(s)</a>), we saw the differences between the various OAuth2/OpenID Connect flows. In this one, we&#39;ll see how to reference the ASOS package and how to register it in the ASP.NET Core pipeline.</p><hr><h3 id="Referencing_the_OpenID_Connect_server_middleware_package"><a href="#Referencing_the_OpenID_Connect_server_middleware_package" class="headerlink" title="Referencing the OpenID Connect server middleware package"></a>Referencing the OpenID Connect server middleware package</h3><div class="note info"><p><strong>This post assumes you&#39;re using ASOS beta 6 (for ASP.NET Core RTM)</strong>, which is, at the time of writing, the latest official release.</p></div><p>To reference ASOS, simply add <code>&quot;AspNet.Security.OpenIdConnect.Server&quot;: &quot;1.0.0-beta6-final&quot;</code> under the <code>dependencies</code> node of your <code>project.json</code> file:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">dependencies</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">AspNet.Security.OpenIdConnect.Server</span>": <span class="value"><span class="string">"1.0.0-beta6-final"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="Referencing_the_OAuth2_validation_middleware"><a href="#Referencing_the_OAuth2_validation_middleware" class="headerlink" title="Referencing the OAuth2 validation middleware"></a>Referencing the OAuth2 validation middleware</h3><p>You&#39;ll also need to add the validation middleware, <strong>in charge of verifying/decrypting the tokens produced by ASOS</strong> and protecting your API endpoints:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">dependencies</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">AspNet.Security.OAuth.Validation</span>": <span class="value"><span class="string">"1.0.0-alpha2-final"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure><p>The <a href="https://github.com/aspnet-contrib/AspNet.Security.OAuth.Extensions/tree/master/src/AspNet.Security.OAuth.Validation">validation middleware</a> is similar to the JWT bearer middleware developed by the ASP.NET team but was specifically designed to use the encrypted tokens issued by ASOS and to <strong>offer a much easier experience</strong> (it doesn&#39;t require any explicit configuration by default).</p><div class="note tip"><p>Starting with ASOS beta5, <a href="https://github.com/aspnet-contrib/AspNet.Security.OpenIdConnect.Server/issues/185">JWT is no longer the default format for access tokens</a>, but is still supported natively. To use JWT tokens instead of opaque/encrypted tokens, follow the steps below:</p><ul><li>Remove the reference to <code>AspNet.Security.OAuth.Validation</code> in <code>project.json</code>.</li><li>Remove the validation middleware registration (<code>app.UseOAuthValidation()</code>),</li><li>Reference the <code>Microsoft.AspNetCore.Authentication.JwtBearer</code> package.</li><li>Register the JWT middleware using <code>app.UseJwtBearerAuthentication()</code>.</li><li>Assign <code>options.AccessTokenHandler = new JwtSecurityTokenHandler()</code> to override the default format.</li></ul></div><p class="article-more-link"><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/">Read more</a></p></div><footer class="article-footer"><a data-url="http://kevinchalet.com/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/" data-id="cis3b6p19000xz8i26s2jwpxo" class="article-share-link">Share</a> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/#disqus_thread" class="article-comment-link">Comments</a><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asp-net-core/">asp.net core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnet-contrib/">aspnet-contrib</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/authentication/">authentication</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jwt/">jwt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oauth/">oauth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openid-connect/">openid connect</a></li></ul></footer></div></article><article id="post-creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/">Creating your own OpenID Connect server with ASOS: choosing the right flow(s)</a></h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/"><time datetime="2016-07-13T15:15:00.000Z" itemprop="datePublished">2016-07-13</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/development/">Development</a></div></div></header><div class="article-entry" itemprop="articleBody"><div class="note tip"><p>This post is the second part of a series of blog posts entitled <strong>Creating your own OpenID Connect server with ASOS</strong>:</p><ol><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-introduction/" title="Introduction">Introduction</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/" title="Choosing the right flow(s)">Choosing the right flow(s)</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/" title="Registering the middleware in the ASP.NET Core pipeline">Registering the middleware in the ASP.NET Core pipeline</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/" title="Creating your own authorization provider">Creating your own authorization provider</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/" title="Implementing the resource owner password credentials grant">Implementing the resource owner password credentials grant</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-authorization-code-and-implicit-flows/" title="Implementing the authorization code and implicit flows">Implementing the authorization code and implicit flows</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-adding-custom-claims-and-granting-scopes/" title="Adding custom claims and granting scopes">Adding custom claims and granting scopes</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-testing-your-authorization-server-with-postman/" title="Testing your authorization server with Postman">Testing your authorization server with Postman</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-conclusion/" title="Conclusion">Conclusion</a></li></ol></div><p>ASOS offers built-in support for all the standard flows defined by the <a href="https://tools.ietf.org/html/rfc6749">OAuth2</a> and <a href="https://openid.net/specs/openid-connect-core-1_0.html">OpenID Connect</a> core specifications: <a href="http://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth">the authorization code flow</a>, <a href="http://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth">the implicit flow</a>, <a href="http://openid.net/specs/openid-connect-core-1_0.html#HybridFlowAuth">the hybrid flow</a> (which is basically a mix between the first two flows), <a href="https://tools.ietf.org/html/rfc6749#section-4.3">the resource owner password credentials grant</a> and <a href="https://tools.ietf.org/html/rfc6749#section-4.4">the client credentials grant</a>.</p><p>Though not specific to ASOS, choosing the best flow(s) for your application is an <strong>important prerequisite</strong> when implementing your own authorization server ; so here&#39;s a quick overview of the different OAuth2/OpenID Connect flows:</p><hr><h2 id="Non-interactive_flows"><a href="#Non-interactive_flows" class="headerlink" title="Non-interactive flows"></a>Non-interactive flows</h2><h3 id="Resource_owner_password_credentials_flow"><a href="#Resource_owner_password_credentials_flow" class="headerlink" title="Resource owner password credentials flow"></a>Resource owner password credentials flow</h3><p>Directly inspired by <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">basic authentication</a>, the resource owner password credentials grant (abbreviated <em>ROPC</em>) is probably <strong>the simplest OAuth2 flow</strong>: the client application asks the user his username/password, sends a token request to the authorization server with the user credentials (and depending on the client authentication policy defined by the authorization server, its own client credentials) and gets back an access token it can use to retrieve the user&#39;s resources.</p><img src="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/resource-owner-password-flow.png" alt="resource-owner-password-flow.png"><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="request">POST <span class="string">/connect/token</span> HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span>: <span class="string">server.example.com</span></span><br><span class="line"><span class="attribute">Content-Type</span>: <span class="string">application/x-www-form-urlencoded</span></span><br><span class="line"></span><br><span class="line"><span class="bash">grant_<span class="built_in">type</span>=password&amp;username=johndoe&amp;password=A3ddj3w</span></span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="status">HTTP/1.1 <span class="number">200</span> OK</span></span><br><span class="line"><span class="attribute">Content-Type</span>: <span class="string">application/json;charset=UTF-8</span></span><br><span class="line"><span class="attribute">Cache-Control</span>: <span class="string">no-store</span></span><br><span class="line"><span class="attribute">Pragma</span>: <span class="string">no-cache</span></span><br><span class="line"></span><br><span class="line"><span class="json">&#123;</span><br><span class="line">  "<span class="attribute">access_token</span>":<span class="value"><span class="string">"2YotnFZFEjr1zCsicMWpAA"</span></span>,</span><br><span class="line">  "<span class="attribute">token_type</span>":<span class="value"><span class="string">"bearer"</span></span>,</span><br><span class="line">  "<span class="attribute">expires_in</span>":<span class="value"><span class="number">3600</span></span><br><span class="line"></span>&#125;</span></span><br></pre></td></tr></table></figure><p>Though <strong>not recommended by the OAuth2 specification</strong> as it&#39;s the only flow where <strong>the user password is directly exposed to the client application</strong> (which breaks the principle of least privilege), the resource owner password credentials grant is one of the most popular flows.</p><p>It is is particularly appreciated by SPA writers as it&#39;s trivial to implement in vanilla JavaScript, doesn&#39;t involve any redirection or consent form and, unlike interactive flows, doesn&#39;t require implementing token validation or cross-site request forgery (XSRF) countermeasures to prevent session fixation attacks.</p><div class="note tip"><p>If you don&#39;t feel comfortable with the other flows (and the security measures they require on the client-side), using ROPC might be a good option: <strong>paradoxically, a client application using ROPC will be far less vulnerable than a client using interactive flows without implementing the appropriate security checks.</strong></p></div><div class="note warn"><p><a href="https://tools.ietf.org/html/rfc6749#section-4.3">As recommended by the OAuth2 specification</a>, <strong>you SHOULD NEVER use it with third-party applications</strong>. If you want to support applications you don&#39;t <strong>fully trust</strong>, consider using an interactive flow instead (e.g authorization code or implicit flow).</p></div><p class="article-more-link"><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/">Read more</a></p></div><footer class="article-footer"><a data-url="http://kevinchalet.com/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/" data-id="cis3b6p270029z8i2hwnwces8" class="article-share-link">Share</a> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/#disqus_thread" class="article-comment-link">Comments</a><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asp-net-core/">asp.net core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnet-contrib/">aspnet-contrib</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/authentication/">authentication</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jwt/">jwt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oauth/">oauth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openid-connect/">openid connect</a></li></ul></footer></div></article><article id="post-creating-your-own-openid-connect-server-with-asos-introduction" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-introduction/">Creating your own OpenID Connect server with ASOS: introduction</a></h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-introduction/"><time datetime="2016-07-13T15:00:00.000Z" itemprop="datePublished">2016-07-13</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/development/">Development</a></div></div></header><div class="article-entry" itemprop="articleBody"><div class="note tip"><p>This post is the first part of a series of blog posts entitled <strong>Creating your own OpenID Connect server with ASOS</strong>:</p><ol><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-introduction/" title="Introduction">Introduction</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-choosing-the-right-flows/" title="Choosing the right flow(s)">Choosing the right flow(s)</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-registering-the-middleware-in-the-asp-net-core-pipeline/" title="Registering the middleware in the ASP.NET Core pipeline">Registering the middleware in the ASP.NET Core pipeline</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-creating-your-own-authorization-provider/" title="Creating your own authorization provider">Creating your own authorization provider</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-resource-owner-password-credentials-grant/" title="Implementing the resource owner password credentials grant">Implementing the resource owner password credentials grant</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-authorization-code-and-implicit-flows/" title="Implementing the authorization code and implicit flows">Implementing the authorization code and implicit flows</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-adding-custom-claims-and-granting-scopes/" title="Adding custom claims and granting scopes">Adding custom claims and granting scopes</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-testing-your-authorization-server-with-postman/" title="Testing your authorization server with Postman">Testing your authorization server with Postman</a></li><li><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-conclusion/" title="Conclusion">Conclusion</a></li></ol></div><h2 id="What_26_2339_3Bs_ASOS_3F"><a href="#What_26_2339_3Bs_ASOS_3F" class="headerlink" title="What&#39;s ASOS?"></a>What&#39;s ASOS?</h2><p><a href="https://github.com/aspnet-contrib/AspNet.Security.OpenIdConnect.Server">AspNet.Security.OpenIdConnect.Server (codenamed ASOS)</a> is an open-source <strong>OAuth2/OpenID Connect server middleware for OWIN/Katana and ASP.NET Core 1.0</strong> (previously known as ASP.NET 5), designed to work on both the full .NET desktop framework and the new .NET Core platform. It is part of the <a href="https://github.com/aspnet-contrib">aspnet-contrib initiative</a>, that&#39;s also behind <a href="https://github.com/aspnet-contrib/AspNet.Security.OAuth.Providers">the OAuth2 social providers for ASP.NET Core</a>.</p><p>Forked from Katana&#39;s <a href="http://stackoverflow.com/a/29144031/542757">now deprecated OAuth2 authorization server middleware</a>, ASOS shares the same <strong>same low-level, protocol-first approach</strong> but comes with many new OpenID Connect features (e.g <a href="https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata">provider configuration discovery</a>, <a href="https://openid.net/specs/openid-connect-session-1_0.html#RPLogout">client-initiated logout</a> or <a href="http://openid.net/specs/openid-connect-core-1_0.html#UserInfo">userinfo support</a>) and implements some of the recent OAuth2 specifications like <a href="https://tools.ietf.org/html/rfc7009">token revocation</a> or <a href="https://tools.ietf.org/html/rfc7662">token introspection</a> (kudos to <a href="https://github.com/MonkeyJamboree">Michael Ciarlillo</a> for his great contribution!).</p><hr><h2 id="How_is_it_different_from_the_other_identity_servers_3F"><a href="#How_is_it_different_from_the_other_identity_servers_3F" class="headerlink" title="How is it different from the other identity servers?"></a>How is it different from the other identity servers?</h2><p>Unlike other identity server projects, <strong>ASOS only focuses on the OAuth2/OpenID Connect protocol part</strong> and acts as a thin layer between your application and the protocol details: it comes with no membership feature, implementing the consent pages is left as an exercise and adding a CORS policy must be done by the developer depending on his/her own needs.</p><p>Though it requires a <strong>solid knowledge of the OAuth2/OpenID Connect specifications</strong> and generally needs more work than turnkey solutions (like the famous <a href="https://github.com/IdentityServer/IdentityServer3">IdentityServer</a> or <a href="https://github.com/openiddict/openiddit-core">OpenIddict</a>), ASOS offers the most flexible approach and can be easily integrated to any existing environment.</p><p class="article-more-link"><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-introduction/">Read more</a></p></div><footer class="article-footer"><a data-url="http://kevinchalet.com/2016/07/13/creating-your-own-openid-connect-server-with-asos-introduction/" data-id="cis3b6p1f0015z8i2dxopzbmw" class="article-share-link">Share</a> <a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-introduction/#disqus_thread" class="article-comment-link">Comments</a><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asp-net-core/">asp.net core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnet-contrib/">aspnet-contrib</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/authentication/">authentication</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jwt/">jwt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oauth/">oauth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openid-connect/">openid connect</a></li></ul></footer></div></article><nav id="page-nav"><a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span></nav></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">recents</h3><div class="widget"><ul id="recent-post" class="no-thumbnail"><li><div class="item-inner"><p class="item-title"><a href="/2016/08/22/using-a-local-oauth2-openid-connect-server-with-webauthenticationbroker/" class="title">Using a local OAuth2/OpenID Connect server with WebAuthenticationBroker</a></p><p class="item-date"><time datetime="2016-08-22T14:30:00.000Z" itemprop="datePublished">2016-08-22</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-conclusion/" class="title">Creating your own OpenID Connect server with ASOS: conclusion</a></p><p class="item-date"><time datetime="2016-07-13T17:00:00.000Z" itemprop="datePublished">2016-07-13</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-testing-your-authorization-server-with-postman/" class="title">Creating your own OpenID Connect server with ASOS: testing your authorization server with Postman</a></p><p class="item-date"><time datetime="2016-07-13T16:45:00.000Z" itemprop="datePublished">2016-07-13</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-adding-custom-claims-and-granting-scopes/" class="title">Creating your own OpenID Connect server with ASOS: adding custom claims and granting scopes</a></p><p class="item-date"><time datetime="2016-07-13T16:30:00.000Z" itemprop="datePublished">2016-07-13</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2016/07/13/creating-your-own-openid-connect-server-with-asos-implementing-the-authorization-code-and-implicit-flows/" class="title">Creating your own OpenID Connect server with ASOS: implementing the authorization code and implicit flows</a></p><p class="item-date"><time datetime="2016-07-13T16:15:00.000Z" itemprop="datePublished">2016-07-13</time></p></div></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/development/">Development</a><span class="category-list-count">10</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">tags</h3><div class="widget"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/asp-net-core/">asp.net core</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnet-contrib/">aspnet-contrib</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/authentication/">authentication</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jwt/">jwt</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oauth/">oauth</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openid-connect/">openid connect</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uwp/">uwp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-authentication-broker/">web authentication broker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows-10/">windows 10</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">9</span></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2016 Kévin Chalet<br>Proudly powered by <a href="http://hexo.io/" target="_blank">Hexo</a> with <a href="http://github.com/ppoffice" target="_blank">Ruipeng Zhang</a>'s <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus theme</a> and <a href="https://www.flickr.com/photos/madison_slater/" target="_blank">Madison Slater</a>'s <a href="https://www.flickr.com/photos/madison_slater/11299339856/" target="_blank">photos</a>.</div></div></footer><script>var disqus_shortname="kevinchalet";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script><script src="/js/jquery.js" type="text/javascript"></script><script src="/js/script.js" type="text/javascript"></script></div></body>