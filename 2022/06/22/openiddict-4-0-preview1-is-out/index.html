<!DOCTYPE html><html><head><meta charset="utf-8"><title>OpenIddict 4.0 preview1 is out | K√©vin Chalet&#39;s blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Earlier today, the first OpenIddict 4.0 preview was pushed to NuGet.org üéâ As always, all the changes can be found on GitHub but here&#39;s a recap of the most interesting ones: What&#39;s new?OpenIddict now"><meta property="og:type" content="article"><meta property="og:title" content="OpenIddict 4.0 preview1 is out"><meta property="og:url" content="https://kevinchalet.com/2022/06/22/openiddict-4-0-preview1-is-out/index.html"><meta property="og:site_name" content="K√©vin Chalet&#39;s blog"><meta property="og:description" content="Earlier today, the first OpenIddict 4.0 preview was pushed to NuGet.org üéâ As always, all the changes can be found on GitHub but here&#39;s a recap of the most interesting ones: What&#39;s new?OpenIddict now"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2022-06-22T18:00:00.000Z"><meta property="article:modified_time" content="2023-12-18T14:15:43.000Z"><meta property="article:author" content="K√©vin Chalet"><meta property="article:tag" content="oauth"><meta property="article:tag" content="openid connect"><meta property="article:tag" content="asp.net core"><meta property="article:tag" content="authentication"><meta property="article:tag" content="jwt"><meta property="article:tag" content="openiddict"><meta property="article:tag" content="aspnet-contrib"><meta name="twitter:card" content="summary"><meta name="twitter:creator" content="@kevin_chalet"><link rel="icon" href="https://kevinchalet.com/assets/photo.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css"><script type="text/javascript">!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-79360312-1","auto"),ga("send","pageview")</script><meta name="generator" content="Hexo 6.2.0"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style></head><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><span class="site-title">K√©vin Chalet&#39;s blog</span></a><nav id="main-nav"><a class="main-nav-link" href="/.">Home</a> <a class="main-nav-link" href="/archives/">Archives</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"><a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://kevinchalet.com/assets/photo.png"><i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"></button><input type="hidden" name="sitesearch" value="https://kevinchalet.com"></form></div></div></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"><img id="avatar" src="https://kevinchalet.com/assets/photo.png"><h2 id="name">K√©vin Chalet</h2><h3 id="title">.NET-holic and OpenID-addict MVP in the wild.</h3><span id="location"><i class="fa fa-map-marker"></i>France</span> <a id="follow" target="_blank" rel="noopener" href="https://twitter.com/intent/user?screen_name=kevin_chalet"><i class="fa fa-twitter fa-lg"></i> Follow me on Twitter</a></div><div class="article-info profile-block"><div class="article-info-block">46 <span>posts</span></div><div class="article-info-block">37 <span>tags</span></div></div><div class="contact-info profile-block"><table class="contact-list"><tr><td><a href="mailto:contact@kevinchalet.com" title="Email"><i class="fa fa-envelope"></i></a></td><td><a target="_blank" rel="noopener" href="https://www.linkedin.com/in/kevinchalet/" title="LinkedIn"><i class="fa fa-linkedin"></i></a></td><td><a target="_blank" rel="noopener" href="https://github.com/kevinchalet" title="GitHub"><i class="fa fa-github"></i></a></td><td><a target="_blank" rel="noopener" href="https://twitter.com/kevin_chalet" title="Twitter"><i class="fa fa-twitter"></i></a></td><td><a target="_blank" rel="noopener" href="https://stackoverflow.com/users/542757/k%c3%a9vin-chalet" title="StackOverflow"><i class="fa fa-stack-overflow"></i></a></td><td><a target="_blank" rel="noopener" href="https://mvp.microsoft.com/fr-fr/PublicProfile/5001682" title="Microsoft MVP"><i class="fa fa-windows"></i></a></td><td><a href="/atom.xml" title="RSS"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-openiddict-4-0-preview1-is-out" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">OpenIddict 4.0 preview1 is out</h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2022/06/22/openiddict-4-0-preview1-is-out/"><time datetime="2022-06-22T18:00:00.000Z" itemprop="datePublished">2022-06-22</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/development/">Development</a></div></div></header><div class="article-entry" itemprop="articleBody"><p>Earlier today, the first OpenIddict 4.0 preview was pushed to NuGet.org üéâ</p><p>As always, all the changes can be found on <a target="_blank" rel="noopener" href="https://github.com/openiddict/openiddict-core/pulls?q=is:pr+milestone:4.0.0-preview1+is:closed">GitHub</a> but here's a recap of the most interesting ones:</p><h2 id="What-39-s-new"><a href="#What-39-s-new" class="headerlink" title="What's new?"></a>What's new?</h2><h3 id="OpenIddict-now-includes-a-client-stack"><a href="#OpenIddict-now-includes-a-client-stack" class="headerlink" title="OpenIddict now includes a client stack"></a>OpenIddict now includes a client stack</h3><p><strong>The introduction of a client stack in 4.0 is by far the most exciting change (well, at least for me üòÅ)</strong>.</p><p>If you missed <a href="/2022/02/25/introducing-the-openiddict-client/" title="my previous post">my previous post</a>, I'd suggest reading it first as it details the motivation for creating it and the differences with existing offers like the ASP.NET Core OpenID Connect or OAuth 2.0 handlers.</p><h3 id="The-OpenIddict-client-will-come-with-a-companion-package-to-simplify-well-known-Web-services-integrations"><a href="#The-OpenIddict-client-will-come-with-a-companion-package-to-simplify-well-known-Web-services-integrations" class="headerlink" title="The OpenIddict client will come with a companion package to simplify well-known Web services integrations"></a>The OpenIddict client will come with a companion package to simplify well-known Web services integrations</h3><p>I had mentioned in my previous blog post that I was interested in developing an alternative to <a target="_blank" rel="noopener" href="https://github.com/aspnet-contrib/AspNet.Security.OAuth.Providers">the aspnet-contrib providers</a> that would be based on the new OpenIddict client instead of the ASP.NET Core 2.0 base handler and would have the following advantages:</p><ul><li><p>Thanks to its dual-protocol nature, the OpenIddict client could enforce all the security checks introduced by OpenID Connect that a simple OAuth 2.0 client implementation like the ASP.NET Core OAuth 2.0 base handler wouldn't support, which means we could easily support both OAuth 2.0 and OpenID Connect providers without sacrificing security.</p></li><li><p>By being natively compatible with ASP.NET Core (from 2.1 to 7.0) and OWIN/Katana 4.2, the providers built on top of the OpenIddict client could be used in both recent ASP.NET Core apps and legacy ASP.NET &gt;= 4.6.1 apps, making them usable in many more applications than the aspnet-contrib providers, that always target the most recent ASP.NET Core version.</p></li><li><p>Unlike the OAuth 2.0 base handler developed by Microsoft, the OpenIddict client comes with a composable events model that could allow eliminating code that we needed to copy in the aspnet-contrib providers when overriding certain <code>OAuthHandler</code> methods.</p></li></ul><p><strong>The good news is that this idea materialized as a dedicated <code>OpenIddict.Client.WebIntegration</code> package</strong> that depends on <code>OpenIddict.Client</code> and includes the logic necessary to deal with all the non-standard aspects of each supported provider. Unlike the aspnet-contrib providers, <code>OpenIddict.Client.WebIntegration</code> relies on Roslyn Source Generators to dynamically create all the plumbing code, which makes it much easier to maintain. If you're interested in learning more about the technical details, <a target="_blank" rel="noopener" href="https://github.com/openiddict/openiddict-core/pull/1396">don't miss the PR that introduced it</a>.</p><p>If you're already familiar with the aspnet-contrib providers, migrating to the OpenIddict-based providers shouldn't be too complicated:</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">services.AddOpenIddict()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register the OpenIddict core components.</span></span><br><span class="line">    .AddCore(options =&gt;</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// Configure OpenIddict to use the Entity Framework Core stores and models.</span></span><br><span class="line">        <span class="comment">// Note: call ReplaceDefaultEntities() to replace the default OpenIddict entities.</span></span><br><span class="line">        options.UseEntityFrameworkCore()</span><br><span class="line">               .UseDbContext&lt;ApplicationDbContext&gt;();</span><br><span class="line">    })</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register the OpenIddict client components.</span></span><br><span class="line">    .AddClient(options =&gt;</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// Enable the redirection endpoint needed to handle the callback stage.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Note: to mitigate mix-up attacks, it's recommended to use a unique redirection endpoint</span></span><br><span class="line">        <span class="comment">// address per provider, unless all the registered providers support returning an "iss"</span></span><br><span class="line">        <span class="comment">// parameter containing their URL as part of authorization responses. For more information,</span></span><br><span class="line">        <span class="comment">// see https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics#section-4.4.</span></span><br><span class="line">        options.SetRedirectionEndpointUris(</span><br><span class="line">            <span class="string">"/signin-local"</span>,</span><br><span class="line">            <span class="string">"/signin-github"</span>,</span><br><span class="line">            <span class="string">"/signin-google"</span>,</span><br><span class="line">            <span class="string">"/signin-reddit"</span>,</span><br><span class="line">            <span class="string">"/signin-twitter"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register the signing and encryption credentials used to protect</span></span><br><span class="line">        <span class="comment">// sensitive data like the state tokens produced by OpenIddict.</span></span><br><span class="line">        options.AddDevelopmentEncryptionCertificate()</span><br><span class="line">               .AddDevelopmentSigningCertificate();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register the ASP.NET Core host and configure the ASP.NET Core-specific options.</span></span><br><span class="line">        options.UseAspNetCore()</span><br><span class="line">               .EnableStatusCodePagesIntegration()</span><br><span class="line">               .EnableRedirectionEndpointPassthrough();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register the Web providers integrations.</span></span><br><span class="line">        options.UseWebProviders()</span><br><span class="line">               .AddGitHub(<span class="keyword">new</span>()</span><br><span class="line">               {</span><br><span class="line">                   ClientId = <span class="string">"[client identifier]"</span>,</span><br><span class="line">                   ClientSecret = <span class="string">"[client secret]"</span>,</span><br><span class="line">                   RedirectUri = <span class="keyword">new</span> Uri(<span class="string">"https://localhost:44381/signin-github"</span>, UriKind.Absolute)</span><br><span class="line">               })</span><br><span class="line">               .AddGoogle(<span class="keyword">new</span>()</span><br><span class="line">               {</span><br><span class="line">                   ClientId = <span class="string">"[client identifier]"</span>,</span><br><span class="line">                   ClientSecret = <span class="string">"[client secret]"</span>,</span><br><span class="line">                   RedirectUri = <span class="keyword">new</span> Uri(<span class="string">"https://localhost:44381/signin-google"</span>, UriKind.Absolute),</span><br><span class="line">                   Scopes = { Scopes.Profile }</span><br><span class="line">               });</span><br><span class="line">    });</span><br></pre></td></tr></tbody></table></figure><span id="more"></span><p><strong>The following providers are already part of OpenIddict 4.0 preview1</strong> and it's likely external contributions will introduce additional providers in future versions:</p><table><thead><tr><th>Provider name</th></tr></thead><tbody><tr><td>Apple</td></tr><tr><td>GitHub</td></tr><tr><td>Google</td></tr><tr><td>Microsoft</td></tr><tr><td>Reddit</td></tr><tr><td>Twitter</td></tr></tbody></table><p>For more information about the differences between the aspnet-contrib providers and the OpenIddict-based providers, read <a target="_blank" rel="noopener" href="https://github.com/aspnet-contrib/AspNet.Security.OAuth.Providers/issues/694">Introducing the OpenIddict-powered providers</a></p><p><strong>If you're interested in seeing a specific provider supported, please open <a target="_blank" rel="noopener" href="https://github.com/openiddict/openiddict-core/issues/new?assignees=&amp;labels=enhancement,client+stack,web+providers&amp;template=new_provider.yml">a ticket on GitHub</a></strong>.</p><p><strong>The OpenIddict client and the Web integration companion package will be compatible with the following .NET environments</strong>:</p><table><thead><tr><th>Web framework version</th><th>.NET runtime version</th></tr></thead><tbody><tr><td>ASP.NET Core 2.1</td><td>.NET Framework 4.6.1</td></tr><tr><td>ASP.NET Core 2.1</td><td>.NET Framework 4.7.2</td></tr><tr><td>ASP.NET Core 2.1</td><td>.NET Framework 4.8</td></tr><tr><td></td><td></td></tr><tr><td>ASP.NET Core 3.1</td><td>.NET Core 3.1</td></tr><tr><td></td><td></td></tr><tr><td>ASP.NET Core 6.0</td><td>.NET 6.0</td></tr><tr><td>ASP.NET Core 7.0</td><td>.NET 7.0</td></tr><tr><td></td><td></td></tr><tr><td>Microsoft.Owin 4.2</td><td>.NET Framework 4.6.1</td></tr><tr><td>Microsoft.Owin 4.2</td><td>.NET Framework 4.7.2</td></tr><tr><td>Microsoft.Owin 4.2</td><td>.NET Framework 4.8</td></tr></tbody></table><div class="note tip"><p>At this stage, it's still unclear whether support for Blazor will be part of 4.0 RTM as discussions around <a target="_blank" rel="noopener" href="https://github.com/dotnet/aspnetcore/issues/40764">Blazor's authentication stack are still pending</a>. I hope I'll hear from the ASP.NET team in the near future.</p></div><h3 id="The-token-generation-x2F-validation-pipeline-got-a-massive-overhaul"><a href="#The-token-generation-x2F-validation-pipeline-got-a-massive-overhaul" class="headerlink" title="The token generation/validation pipeline got a massive overhaul"></a>The token generation/validation pipeline got a massive overhaul</h3><p>While this change should be invisible to most OpenIddict users, <strong>the <code>ProcessAuthentication</code> and <code>ProcessSignIn</code> events were revamped in 4.0 to be much more flexible and give advanced users more control</strong> over the token generation and validation processes.</p><p>As part of this change, two new "sub-events" named <code>GenerateToken(Context)</code> and <code>ValidateToken(Context)</code> were introduced to enable the following scenarios:</p><ul><li>The token format (JWT or ASP.NET Core Data Protection) can now be controlled dynamically.</li><li>Whether the token will have a corresponding entry in the database can now be controlled dynamically.</li><li>Whether the token will be a reference token can now be controlled dynamically.</li></ul><h3 id="The-OpenIddict-claims-extensions-were-reworked"><a href="#The-OpenIddict-claims-extensions-were-reworked" class="headerlink" title="The OpenIddict claims extensions were reworked"></a>The OpenIddict claims extensions were reworked</h3><p>In previous versions, OpenIddict offered various extensions for <code>ClaimsPrincipal</code> but not for <code>ClaimsIdentity</code>, which made working with the latter (common with the OWIN integration, where <code>AuthenticationTicket.Identity</code> is a <code>ClaimsIdentity</code>) quite cumbersome. <strong>To fix that, many new extensions and overloads have been introduced for both <code>ClaimsPrincipal</code> and <code>ClaimsIdentity</code></strong>.</p><div class="note warn"><p>As part of this change, the <code>AddClaim</code> overloads taking a list of claim destinations have been removed as overloads taking <code>params string[]</code> parameters were too hard to version. Instead, users are encouraged to use the new <code>SetDestinations()</code> overload on <code>ClaimsIdentity</code>/<code>ClaimsPrincipal</code> to set claim destinations of all claims in a single pass:</p></div><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">principal.SetDestinations(<span class="keyword">static</span> claim =&gt; claim.Type <span class="keyword">switch</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// Allow the "name" claim  to be stored in both the access and identity tokens</span></span><br><span class="line">    <span class="comment">// when the "profile" scope was granted (by calling principal.SetScopes(...)).</span></span><br><span class="line">    Claims.Name <span class="keyword">when</span> claim.Subject.HasScope(Scopes.Profile)</span><br><span class="line">        =&gt; <span class="keyword">new</span>[] { Destinations.AccessToken, Destinations.IdentityToken },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Otherwise, only store the claim in the access tokens.</span></span><br><span class="line">    _ =&gt; <span class="keyword">new</span>[] { Destinations.AccessToken }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="netcoreapp2-1-and-net5-0-TFMs-were-removed"><a href="#netcoreapp2-1-and-net5-0-TFMs-were-removed" class="headerlink" title="netcoreapp2.1 and net5.0 TFMs were removed"></a><code>netcoreapp2.1</code> and <code>net5.0</code> TFMs were removed</h3><p>.NET Core 2.1 and .NET 5.0 are no longer supported by Microsoft so <strong>the OpenIddict 4.0 packages no longer target <code>netcoreapp2.1</code> and <code>net5.0</code></strong>. While OpenIddict 4.0 can still be used on .NET Core 2.1 and .NET 5.0 thanks to its .NET Standard 2.0 TFM, users are encouraged to migrate to a supported .NET version to ensure they can receive security fixes.</p><p>OpenIddict 4.0 ‚Äì client, server and validation ‚Äì will still be fully compatible with ASP.NET Core 2.1 on .NET Framework 4.6.1 and higher (that has the same support lifecycle as ASP.NET 4.x applications).</p><h3 id="Support-for-the-iss-parameter-was-added-to-the-OpenIddict-server"><a href="#Support-for-the-iss-parameter-was-added-to-the-OpenIddict-server" class="headerlink" title="Support for the iss parameter was added to the OpenIddict server"></a>Support for the <code>iss</code> parameter was added to the OpenIddict server</h3><p><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc9207">Standardized in March 2022</a>, the <code>iss</code> authorization response parameter was introduced by RFC9207 as a way for OAuth 2.0 (and OpenID Connect) clients that support multiple providers to mitigate mix-up attacks. Since it's an important security measure, <strong>native <code>iss</code> support was added to the OpenIddict server and client stacks</strong>.</p><h3 id="System-Text-Json-Nodes-is-now-fully-supported-on-NET-gt-x3D-6-0"><a href="#System-Text-Json-Nodes-is-now-fully-supported-on-NET-gt-x3D-6-0" class="headerlink" title="System.Text.Json.Nodes is now fully supported on .NET >= 6.0"></a><code>System.Text.Json.Nodes</code> is now fully supported on .NET &gt;= 6.0</h3><p><strong>The <code>OpenIddictParameter</code> primitive was updated to support <code>JsonObject</code>, <code>JsonArray</code> and <code>JsonValue</code> on .NET &gt;= 6.0</strong> (the lower-level <code>JsonElement</code> struct is already supported by OpenIddict 3.0 on all .NET platforms).</p><p>You can also use these types via <code>AuthenticationProperties</code> to return custom parameters from the OpenIddict endpoints. E.g:</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> properties = <span class="keyword">new</span> AuthenticationProperties</span><br><span class="line">{</span><br><span class="line">    Parameters =</span><br><span class="line">    {</span><br><span class="line">        [<span class="string">"custom_array"</span>] = <span class="keyword">new</span> JsonArray(<span class="number">1</span>, <span class="number">2</span>, <span class="string">"3"</span>)</span><br><span class="line">        [<span class="string">"custom_object"</span>] = <span class="keyword">new</span> JsonObject</span><br><span class="line">        {</span><br><span class="line">            [<span class="string">"property"</span>] = <span class="string">"42"</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> SignIn(principal, properties, OpenIddictServerAspNetCoreDefaults.AuthenticationScheme);</span><br></pre></td></tr></tbody></table></figure><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"access_token"</span><span class="punctuation">:</span> <span class="string">"[access_token]"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"token_type"</span><span class="punctuation">:</span> <span class="string">"Bearer"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"expires_in"</span><span class="punctuation">:</span> <span class="number">3599</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"scope"</span><span class="punctuation">:</span> <span class="string">"openid email profile offline_access demo_api"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"id_token"</span><span class="punctuation">:</span> <span class="string">"[id_token]"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"custom_array"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">"3"</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"custom_object"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"property"</span><span class="punctuation">:</span> <span class="string">"42"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="AuthenticationProperties-Items-is-now-preserved-by-the-OpenIddict-server-and-client-stacks"><a href="#AuthenticationProperties-Items-is-now-preserved-by-the-OpenIddict-server-and-client-stacks" class="headerlink" title="AuthenticationProperties.Items is now preserved by the OpenIddict server and client stacks"></a><code>AuthenticationProperties.Items</code> is now preserved by the OpenIddict server and client stacks</h3><p><strong>In 4.0, the authentication properties are now preserved by the ASP.NET Core and OWIN hosts</strong> in a special claim in all tokens (except access and identity tokens), which was required by the new client stack to flow certain properties set by Identity (e.g the selected external identity provider or a XSRF value bound to the user when associating an external provider to an existing ASP.NET Core Identity account). For consistency, the server stack was updated to offer the same feature.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> properties = _signInManager.ConfigureExternalAuthenticationProperties(</span><br><span class="line">    provider: issuer,</span><br><span class="line">    redirectUrl: Url.Action(<span class="string">"ExternalLoginCallback"</span>, <span class="string">"Account"</span>, <span class="keyword">new</span></span><br><span class="line">    {</span><br><span class="line">        ReturnUrl = Request.PathBase + Request.Path + QueryString.Create(parameters)</span><br><span class="line">    }));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Note: when only one client is registered in the client options,</span></span><br><span class="line"><span class="comment">// setting the issuer property is not required and can be omitted.</span></span><br><span class="line">properties.SetString(OpenIddictClientAspNetCoreConstants.Properties.Issuer, issuer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Challenge(properties, OpenIddictClientAspNetCoreDefaults.AuthenticationScheme);</span><br></pre></td></tr></tbody></table></figure><h3 id="Challenge-handling-in-the-server-and-validation-stacks-was-improved"><a href="#Challenge-handling-in-the-server-and-validation-stacks-was-improved" class="headerlink" title="Challenge handling in the server and validation stacks was improved"></a>Challenge handling in the server and validation stacks was improved</h3><p>Last but not least, <strong>the way authentication challenges are handled by the OpenIddict server and validation services has been massively improved</strong> to be more consistent, standard-compliant and work around annoying issues caused by some OWIN or ASP.NET 4.x components (like the cookies middleware or the FormsAuthentication module) that are known to rewrite 401 responses to 302 redirects even if the response was already fully handled by OpenIddict.</p><p>With 4.0, Katana applications using the cookies middleware with the automatic mode enabled (the default value) or ASP.NET 4.x applications still using <code>FormsAuthenticationModule</code> should no longer require any workaround for their 401 responses to work properly, making the user experience as good as with ASP.NET Core.</p><h2 id="What-39-s-next"><a href="#What-39-s-next" class="headerlink" title="What's next?"></a>What's next?</h2><p>OpenIddict 4.0 preview1 will be the first release to include the new client stack, so it's likely improvements will be made based on the collected feedback. I also plan to include logout support in a future preview. Oh and hopefully, external contributions should also introduce additional providers in the Web integration companion package (at least, I hope so üòÅ).</p></div><footer class="article-footer"><a data-url="https://kevinchalet.com/2022/06/22/openiddict-4-0-preview1-is-out/" data-id="clrkhiim4002nz8i1ep7j79yd" class="article-share-link">Share</a> <a href="/2022/06/22/openiddict-4-0-preview1-is-out/#giscus_discussion" class="article-comment-link">Comments</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asp-net-core/" rel="tag">asp.net core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnet-contrib/" rel="tag">aspnet-contrib</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/authentication/" rel="tag">authentication</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jwt/" rel="tag">jwt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oauth/" rel="tag">oauth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openid-connect/" rel="tag">openid connect</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openiddict/" rel="tag">openiddict</a></li></ul></footer></div><nav id="article-nav"><a href="/2022/12/16/getting-started-with-the-openiddict-web-providers/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">Getting started with the OpenIddict web providers</div></a><a href="/2022/02/25/introducing-the-openiddict-client/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Introducing the OpenIddict client</div></a></nav></article><section id="comments"><div id="giscus_discussion"><script src="https://giscus.app/client.js" data-repo="kevinchalet/kevinchalet.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnk2MTE2NjMwMw==" data-category="General" data-category-id="DIC_kwDOA6VS384CQu8O" data-mapping="og:title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">recents</h3><div class="widget"><ul id="recent-post" class="no-thumbnail"><li><div class="item-inner"><p class="item-title"><a href="/2023/12/18/openiddict-5-0-general-availability/" class="title">OpenIddict 5.0 general availability</a></p><p class="item-date"><time datetime="2023-12-18T16:00:00.000Z" itemprop="datePublished">2023-12-18</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2023/10/20/introducing-native-applications-per-client-token-lifetimes-and-client-assertions-support-in-openiddict-5-0-preview1/" class="title">Introducing native applications, per-client token lifetimes and client assertions support in OpenIddict 5.0 preview1</a></p><p class="item-date"><time datetime="2023-10-20T15:30:00.000Z" itemprop="datePublished">2023-10-20</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2023/10/04/can-you-use-the-asp-net-core-identity-api-endpoints-with-openiddict/" class="title">Can you use the ASP.NET Core Identity API endpoints with OpenIddict?</a></p><p class="item-date"><time datetime="2023-10-04T11:00:00.000Z" itemprop="datePublished">2023-10-04</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2023/07/05/connecting-windows-media-center-to-tvheadend-with-hdhrproxyiptv-an-alternative-to-dvblink/" class="title">Connecting Windows Media Center to Tvheadend with HDHRProxyIPTV: an alternative to DVBLink</a></p><p class="item-date"><time datetime="2023-07-05T18:00:00.000Z" itemprop="datePublished">2023-07-05</time></p></div></li><li><div class="item-inner"><p class="item-title"><a href="/2023/02/27/introducing-system-integration-support-for-the-openiddict-client/" class="title">Introducing system integration support for the OpenIddict client</a></p><p class="item-date"><time datetime="2023-02-27T16:00:00.000Z" itemprop="datePublished">2023-02-27</time></p></div></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/development/">Development</a><span class="category-list-count">35</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/general/">General</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/net/" rel="tag">.net</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/asp-net/" rel="tag">asp.net</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/asp-net-core/" rel="tag">asp.net core</a><span class="tag-list-count">33</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/asp-net-core-identity/" rel="tag">asp.net core identity</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnet-contrib/" rel="tag">aspnet-contrib</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/auth0/" rel="tag">auth0</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/authentication/" rel="tag">authentication</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/azure/" rel="tag">azure</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/azure-ad/" rel="tag">azure ad</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cms/" rel="tag">cms</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/component-object-model/" rel="tag">component object model</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dvblink/" rel="tag">dvblink</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hdhomerun/" rel="tag">hdhomerun</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hdhrproxytv/" rel="tag">hdhrproxytv</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/identity/" rel="tag">identity</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jwt/" rel="tag">jwt</a><span class="tag-list-count">34</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/manifest/" rel="tag">manifest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oauth/" rel="tag">oauth</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/okta/" rel="tag">okta</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openid/" rel="tag">openid</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openid-connect/" rel="tag">openid connect</a><span class="tag-list-count">38</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openiddict/" rel="tag">openiddict</a><span class="tag-list-count">24</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orchard/" rel="tag">orchard</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orchardcore/" rel="tag">orchardcore</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/owin/" rel="tag">owin</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/razor/" rel="tag">razor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tls/" rel="tag">tls</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tv/" rel="tag">tv</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tvheadend/" rel="tag">tvheadend</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uwp/" rel="tag">uwp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vulnerability/" rel="tag">vulnerability</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-authentication-broker/" rel="tag">web authentication broker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-providers/" rel="tag">web providers</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows-10/" rel="tag">windows 10</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows-media-center/" rel="tag">windows media center</a><span class="tag-list-count">2</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">9</span></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2016 - 2024 K√©vin Chalet<br>Proudly powered by <a href="http://hexo.io/" target="_blank">Hexo</a> with <a href="http://github.com/ppoffice" target="_blank">Ruipeng Zhang</a>'s <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus theme</a> and <a href="https://www.flickr.com/photos/madison_slater/" target="_blank">Madison Slater</a>'s <a href="https://www.flickr.com/photos/madison_slater/11299339856/" target="_blank">photos</a>.</div></div></footer><script src="/js/jquery.js"></script><script src="/js/script.js"></script></div></body></html>